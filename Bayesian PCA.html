<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Besian Framework + Stan + PPCA</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Bayesian PCA_files/libs/clipboard/clipboard.min.js"></script>
<script src="Bayesian PCA_files/libs/quarto-html/quarto.js"></script>
<script src="Bayesian PCA_files/libs/quarto-html/popper.min.js"></script>
<script src="Bayesian PCA_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Bayesian PCA_files/libs/quarto-html/anchor.min.js"></script>
<link href="Bayesian PCA_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Bayesian PCA_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Bayesian PCA_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Bayesian PCA_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Bayesian PCA_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<style>html{ scroll-behavior: smooth; }</style>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#pca" id="toc-pca" class="nav-link" data-scroll-target="#pca">PCA</a></li>
  <li><a href="#factor-analysis" id="toc-factor-analysis" class="nav-link" data-scroll-target="#factor-analysis">Factor Analysis</a></li>
  <li><a href="#ppcabayesian-pca" id="toc-ppcabayesian-pca" class="nav-link" data-scroll-target="#ppcabayesian-pca">PPCA/Bayesian PCA</a></li>
  </ul></li>
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods">Methods</a>
  <ul class="collapse">
  <li><a href="#bayesian-framework" id="toc-bayesian-framework" class="nav-link" data-scroll-target="#bayesian-framework">Bayesian Framework</a></li>
  <li><a href="#variation-bayes-estimation" id="toc-variation-bayes-estimation" class="nav-link" data-scroll-target="#variation-bayes-estimation">Variation Bayes Estimation</a></li>
  <li><a href="#data-simulation" id="toc-data-simulation" class="nav-link" data-scroll-target="#data-simulation">Data Simulation</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Besian Framework + Stan + PPCA</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Bayesian PCA and Probabilistic PCA are similar methods but known better as one name or the other in statistics or machine learning fields respectively. Bayesian PCA is used to model latent variable in hierarchical settings by drawing samples from the posterior distribution iteratively. The benefit of this method, in addition to data reduction via PCA, are two things: (1) it allows for probabilistic inference about latent variable within the data, (2) and the selection of the best components are baked into the model which can not otherwise be done using MLE or EM estimation methods. First, let us start with an overview of PCA</p>
<section id="pca" class="level3">
<h3 class="anchored" data-anchor-id="pca">PCA</h3>
<p>The goal of Principal Component Analysis (PCA) is to solely use the data to determine principal components to transform the data as a summary within lower-dimentional space. The variance of the principal components explain the full variance of the data and are often ordered by their standard deviation ultimately used to determine the number of components to retain during the reduction step. Data reduction has the consequence of information loss, but the gain of lower model complexity.</p>
<p>One way the principal components are found are by applying the spectral decomposition method. There are 3 meaningful properties to note here which are:</p>
<ul>
<li><p>(1) Since the variance covariance matrix is symmetric and positive semi-definite it can be decomposed as the following:</p>
<p><span class="math display">\[
Var(X)=Z^TDZ = \begin{bmatrix}z_{11}&amp;..&amp;z_{1p}\\ .&amp;.&amp;.\\z_{n1} &amp;.&amp;z_{np} \end{bmatrix} ^T\begin{bmatrix}\lambda_1\\&amp;.\\&amp;&amp;\lambda_p \end{bmatrix} \begin{bmatrix}z_{11}&amp;..&amp;z_{1p}\\ .&amp;.&amp;.\\z_{n1} &amp;.&amp;z_{np}  \end{bmatrix}
\]</span></p></li>
<li><p>(2) the eiganvalues of the data are the variances of the principal components <span class="math inline">\(B\)</span>,</p>
<p><span class="math display">\[
\begin{align}
Var(B) &amp;=ZVar(X)Z^T \\&amp;= Z(Z^TDZ)Z^T \\ &amp;=D \end{align}
\]</span></p></li>
</ul>
<!-- -->
<ul>
<li>(3) each observation in <span class="math inline">\(X\)</span>, when rotated (multiplied) by the orthogonal matrix <span class="math inline">\(Z\)</span>, is projected on to a line called the principal component.</li>
</ul>
<p><span class="math display">\[
B = ZX\\or\\X=ZB
\]</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Notice this does not require any probabilistic approach and is purely mathematical.</p>
</div>
</div>
<p>In the PCA and social science literature, <span class="math inline">\(q&lt;p\)</span> is usually used and the PC’s that explains the most variance in the data are retained. That is, if we ordered the <span class="math inline">\(q\)</span> PC’s by size of the <span class="math inline">\(\lambda 's\)</span>, indexing them by <span class="math inline">\(j\)</span>, then for <span class="math inline">\(q =3\)</span>; <span class="math inline">\(\lambda_{j=1}&gt;\lambda_{j=2}&gt;\lambda_{j=3}\)</span>. Given this is a deterministic method, if <span class="math inline">\(q = p\)</span> then all the variance of the data would be explained, thus no data reduction/information lost. This data reduction is achieved by choosing a smaller set of principal components <span class="math inline">\(B_q\)</span> and eigenvectors <span class="math inline">\(Z_q\)</span> to approximate <span class="math inline">\(X\)</span> effectively not using all of the rows of <span class="math inline">\(B\)</span>. That is:</p>
<p><span class="math display">\[
X_{nxp} \approx \tilde X_{nxp} = Z_{nxq}B_{qxp}, q&lt;p
\]</span></p>
<p>Essentially, assuming the data was not standardized, for each subject <span class="math inline">\(i\)</span> all of their covariate data can be linearly represented as,</p>
<p><span class="math display">\[x_i=\beta z_i+\mu_p\]</span></p>
<p>or more descriptively for all data observations,</p>
<p><span class="math display">\[ \begin{bmatrix}x_{11}&amp;..&amp;..&amp;x_{1p}\\.&amp;. &amp; &amp;.\\.&amp; &amp;. &amp;.\\x_n &amp;.&amp;.&amp;x_{np} \end{bmatrix} =\begin{bmatrix} z_{11}&amp;.. &amp; z_{1q}\\.&amp;.&amp;.\\z_{n1}&amp;..&amp;z_{nq} \end{bmatrix}\begin{bmatrix}B_{11}&amp;..&amp;..&amp;B_{1p}\\.&amp;.&amp;&amp;.\\.&amp; &amp;.&amp;.\\B_{q1}&amp;.&amp;.&amp;B_{qp} \end{bmatrix}+\begin{bmatrix}\mu_1\\\mu_2\\.\\.\\\mu_p  \end{bmatrix} \]</span></p>
<p>However, in standard practice the covariates are all standardized before deriving the PC’s. Essentially, various sets of the Principal components can then be further used to predict a measure of interest.</p>
<p>Here’s an example retrieving all the covariate information for subject 1. If there are 2 covariates, then there are 2 PC’s and we assume <span class="math inline">\(q=p\)</span> then for subject 1,</p>
<p><span class="math display">\[
\begin{bmatrix}x_{11} &amp; x_{12} \end{bmatrix} = \begin{bmatrix}z_{11}B_{11}+z_{12}B_{21}&amp;
z_{11}B_{12}+z_{12}B_{22}
\end{bmatrix}
\]</span></p>
<p>Likewise for subject 2, but with <span class="math inline">\(q = 1\)</span>, then</p>
<p><span class="math display">\[
\begin{bmatrix}x_{21} &amp; x_{22} \end{bmatrix} \approx \begin{bmatrix}z_{21}B_{11} &amp; z_{21}*B_{12}
\end{bmatrix}
\]</span></p>
<p>To find the acutal principal components <span class="math inline">\(B\)</span>, singular value decomposistion is used to determine Ultimately, PCA is used to reduce the dimensions of the dataset which allows for a less complex model at the expense of information loss. However, this method can not handle missing data, and is subject to outliers influencing the rotation of the PC’s.<br>
<br>
How can we take a probabilistic approach to this and why would we want to? Well, researchers are interested in finding, in probability, the components that explain the most variance so that one can study their latent effects. At the inception of these methods the computational power did not exist and thus lead the discourse to find alternative estimations methods for the marginal versions of the probabilistic model. However, we now have the computational power to retain the full joint posterior of the parameters. The PPCA/Bayesian PCA section will explain the method in detail.</p>
</section>
<section id="factor-analysis" class="level3">
<h3 class="anchored" data-anchor-id="factor-analysis">Factor Analysis</h3>
<p>Historically, Factor Analysis (FA) was very similar to PCA with the slight diffence that an error term was introduced into the model having a covariance matrix that allowed for comparritive error accross individual observations. This was a step closer to a probabilistic framework but not quiet because the principal components or factors derived from the covariance matrix were forced to be orthogonal using SVD methods as in PCA. These factors to, summarize the data in a lower-dimensional space however allow for a distribution on the latent scores that multiply the facotors. Additionaly, the number of factors are often predefined based on data assumptions. For example, if our data set contained covariates associated with social economic status, and transportation, the factor analytical approach would assume the data could be summarized with 2 components. But, should there be an additional factor that has an eigenvalue greater than 1 then it could be considered that there is an unnamed factor that explains an important structural aspect of the data. In conclusion, both PCA and FA are exploratory methods and lack probabilistic properties necessary for statistical inference. Furthermore, more contemporary implementations of FA retain probabilistic properties by reason of spectral decomposition providing the gaussian approach, and thus assuming a distribution on the factors and latent variables they emerge orthogonal which is necessary to map this latent components back to the observed variables. This is better explained in the next section.</p>
</section>
<section id="ppcabayesian-pca" class="level3">
<h3 class="anchored" data-anchor-id="ppcabayesian-pca">PPCA/Bayesian PCA</h3>
<p>This section will first explain the notation used for Probabilistic Principal Component Analysis (PPCA). PPCA is similar in nature if not identical to FA, but the difference only appears for the structure of the covariance matrix of the error terms. FA assumes unique error and thus the off diagonals of the error terms’s covariance matrix are greater than 0 while for PPCA’s they are 0. That is why it has the flavor of PCA, extending it in a probabilistic setting. Like FA, using reasoning from spectral decomposition, the model then minimizes <span class="math inline">\(||x-zB-\mu||=||\epsilon \epsilon^T||\)</span>. According to PCA literature it is standard practice to standardize the covariates as z scores. Thus, it is safe to assume a standard multivariate normal distribution if the data is normalized.</p>
<p><span class="math display">\[x_i=\beta z_i+\mu_p+\epsilon_i \\ \mu \sim N(0,
\bf I_p) \\ \epsilon\sim N(\bf0,\sigma^2\bf I_p)  \]</span></p>
<p>or more descriptively,</p>
<p><span class="math display">\[ \begin{bmatrix}x_{11}&amp;..&amp;..&amp;x_{1p}\\.&amp;. &amp; &amp;.\\.&amp; &amp;. &amp;.\\x_n &amp;.&amp;.&amp;x_{np} \end{bmatrix} =\begin{bmatrix} z_{11}&amp;.. &amp; z_{1q}\\.&amp;.&amp;.\\z_{n1}&amp;.. &amp;z_{nq} \end{bmatrix}\begin{bmatrix}B_{11}&amp;..&amp;..&amp;B_{1p}\\.&amp;.&amp;&amp;.\\.&amp; &amp;.&amp;.\\B_{q1}&amp;.&amp;.&amp;B_{qp} \end{bmatrix}+\begin{bmatrix}\mu_1&amp;\mu_2&amp;..\mu_p  \end{bmatrix}+\begin{bmatrix} \epsilon_1\\\epsilon_2\\.\\.\\ \epsilon_n  \end{bmatrix} \]</span></p>
<p>Given nature of PCA is to minimize the sum of squared error, the distribution assumed for <span class="math inline">\(z\)</span> is forced to be orthogonal. We assume the following distributions on the additional parameters and data.</p>
<p><span class="math display">\[\begin{align}
x_i &amp;\sim N(\mu, \beta \beta^T+\sigma^2 \bf I_p), \mu \sim N(0, \bf I_p)\\
x_i | z_i &amp;\sim N(\beta z_i,\sigma^2 \bf I_p)\\
z_i &amp;\sim N(\bf 0,I_q)\\
\beta_q | \lambda_q &amp;\sim N(\bf 0,\lambda^{-1}_q *\bf I_p)\\
\lambda &amp;\sim Gam(a,b)
\end{align}\]</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note: <span class="math inline">\(\lambda's\)</span> are eigenvalues of the variance of the data which are often used to determine the most important principal components. Also, the covariance matrix of <span class="math inline">\(\epsilon\)</span> is a diagonol matrix marks the distinction from Factor Analysis. Last, orthogonality imerges as of a result of the Gaussian process induced by reason of spectral decomposition.</p>
</div>
</div>
</section>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<section id="bayesian-framework" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-framework">Bayesian Framework</h3>
<p>This section simulates data based on previous distributions within a Bayesian framework. Baye’s method allows us to model the posterior distribution by drawing samples from a proportional prior distribution. Typically in practice the number of components retained are either the PC with the largest eigenvalue as in typically social science literature, or for factor analysis purposes, the PC’s with eigenvalues greater than 1. In the Bayesian framework by setting a prior on the PC’s variance we can allow the model to choose the best PC’s to retain as they are shrunken if the variance explained is very small. The goal is to estimate the following posterior distribution.</p>
<p><span class="math display">\[ P(z,\beta,\mu,\lambda,\sigma^2|x) \propto P(x|\beta, z,\mu,\lambda, \sigma^2)P(z)P(\beta|\lambda)P(\mu)P(\sigma^2)P(\lambda)\]</span></p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note: Factor analysis transformed over the years naturally into a probabilistic approach to data reduction since it was more inherently a statistical method with the goal to become inferential while PCA remained more of a machine learning method with the goal of prediction.</p>
</div>
</div>
<p>Bayesian methods became more popular as computational capacity increased and thus PPCA, Bayesian FA, or Bayesian PCA are virtually synonymous with the emphasis that Bayesian methods are used to estimate the parameters. FA already became probabilistic, and like PPCA, maximum likelihood, or EM algorithm methods were used to estimate the parameters. Since unique error is used for FA there were no closed form solutions for parameters in FA so the EM algorithm was preferred. Also, while computational capacity have been exponentially increasing, the complexity of Bayesian estimation forced researchers to take marginalized approaches to estimating the posterior as opposed to allowing the model to estimate the joint distribution of all the parameters. In the next section, I take advantage of contemporary computing capacity, and Bayesian estimation methods to build a PPC model and analyze the results.</p>
<p>We apply a Bayesian framework to model to determine the conditional probabilities, and lastly, using variational and MCMC methods to produce estimates for the data using Stan.</p>
</section>
<section id="variation-bayes-estimation" class="level3">
<h3 class="anchored" data-anchor-id="variation-bayes-estimation">Variation Bayes Estimation</h3>
<p>Variational estimation is …</p>
</section>
<section id="data-simulation" class="level3">
<h3 class="anchored" data-anchor-id="data-simulation">Data Simulation</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tidyverse"</span>,<span class="st">"patchwork"</span>,<span class="st">"rstan"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(packages, library, <span class="at">character.only =</span> T))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">Initial</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Using 2 PC’s</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">Using p-1 PC’s</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>Simulating the data</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">%&gt;%</span><span class="st">`</span> <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="st">`</span><span class="at">%&gt;%</span><span class="st">`</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>a<span class="ot">=</span> <span class="dv">1</span> <span class="co"># alpha for prior on the PC's</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>b<span class="ot">=</span> <span class="dv">1</span> <span class="co"># beta for the prior on PC's</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">2000</span> <span class="co"># number of subjects</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co"># number of covariates</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># number from reduced dim</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">=</span> <span class="fu">rgamma</span>(<span class="dv">1</span>,<span class="at">shape =</span>a,<span class="at">rate =</span> b) <span class="co"># hyper prior for PC's</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>B <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(p<span class="sc">*</span>q,<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(lambda)), <span class="at">ncol =</span> q) <span class="co"># PC Vectors</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>z <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>q,<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>), <span class="at">ncol =</span> q)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> N, <span class="at">ncol =</span> p)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  x[,i] <span class="ot">=</span> <span class="fu">sum</span>(B[i,]<span class="sc">*</span>z) <span class="sc">+</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Setting up Stan code</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>stan_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N, </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> a, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> b,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> x,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> p,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">q=</span> q</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>mod_file <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">stan_model</span>(<span class="st">"bayes_stan.stan"</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">vb</span>(mod_file,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> stan_list<span class="co">#,</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># pars = c("preds","B","z")</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                   </span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>output_tab <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">summary</span>(fit) <span class="sc">%&gt;%</span> </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>()  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>B.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"B"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), mean)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>z.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"z"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), mean)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>mu.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"mu"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>), mean)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>lambda.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"lambda"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>), mean)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>gplots<span class="sc">::</span><span class="fu">heatmap.2</span>(B.vb, <span class="at">col =</span> gplots<span class="sc">::</span><span class="fu">bluered</span>(<span class="dv">70</span>), <span class="at">dendrogram=</span><span class="st">'none'</span>,<span class="at">trace=</span><span class="st">'none'</span>, <span class="at">Rowv =</span> <span class="cn">FALSE</span>, <span class="at">Colv =</span> <span class="cn">FALSE</span>, <span class="at">key=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Bayesian-PCA_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>gplots<span class="sc">::</span><span class="fu">heatmap.2</span>(z.vb, <span class="at">col =</span> gplots<span class="sc">::</span><span class="fu">bluered</span>(<span class="dv">70</span>), <span class="at">dendrogram=</span><span class="st">'none'</span>,<span class="at">trace=</span><span class="st">'none'</span>, <span class="at">Rowv =</span> <span class="cn">FALSE</span>, <span class="at">Colv =</span> <span class="cn">FALSE</span>, <span class="at">key=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Bayesian-PCA_files/figure-html/unnamed-chunk-4-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Comparing x to the predicted values</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pred matrix</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>x_pred <span class="ot">&lt;-</span>  </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>],</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">201</span><span class="sc">:</span><span class="dv">300</span>],</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">301</span><span class="sc">:</span><span class="dv">400</span>],</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">401</span><span class="sc">:</span><span class="dv">500</span>])</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>x_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>x_pred <span class="sc">%&gt;%</span> </span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V5,</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"covariates"</span>,</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>covariates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Bayesian-PCA_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Table of means for each covariate.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>  x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, covariates) <span class="sc">%&gt;%</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(observations)) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: left;">covariates</th>
<th style="text-align: right;">mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V1</td>
<td style="text-align: right;">-24.214990</td>
</tr>
<tr class="even">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V2</td>
<td style="text-align: right;">36.204404</td>
</tr>
<tr class="odd">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V3</td>
<td style="text-align: right;">24.967718</td>
</tr>
<tr class="even">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V4</td>
<td style="text-align: right;">11.360905</td>
</tr>
<tr class="odd">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V5</td>
<td style="text-align: right;">-27.051076</td>
</tr>
<tr class="even">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V1</td>
<td style="text-align: right;">4.247625</td>
</tr>
<tr class="odd">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V2</td>
<td style="text-align: right;">4.292831</td>
</tr>
<tr class="even">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V3</td>
<td style="text-align: right;">4.255558</td>
</tr>
<tr class="odd">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V4</td>
<td style="text-align: right;">4.285514</td>
</tr>
<tr class="even">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V5</td>
<td style="text-align: right;">4.276693</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># z compared to predicted z </span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  z_pred <span class="ot">&lt;-</span>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"z"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                 output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"z"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>],</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                 output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"z"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">201</span><span class="sc">:</span><span class="dv">300</span>],</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                 output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"z"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">301</span><span class="sc">:</span><span class="dv">400</span>])</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>z_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>z <span class="sc">%&gt;%</span> </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>z_pred <span class="sc">%&gt;%</span> </span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>) <span class="co">#%&gt;% </span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">#rename("V1"=".")</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V4,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"latent"</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>z_comp <span class="sc">%&gt;%</span> </span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>latent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Bayesian-PCA_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>Since <span class="math inline">\(q\)</span> is now greater than 1, we are using a ordering function on <span class="math inline">\(z\)</span>. That kind of changes the distribution from a standard normal but a positively ordered standard normal vector of <span class="math inline">\(q\)</span> scores.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ordering the <span class="math inline">\(z\)</span> parameter also helps to map the predicted <span class="math inline">\(z\)</span> to the actually <span class="math inline">\(z\)</span> parameter for comparison.</p>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">%&gt;%</span><span class="st">`</span> <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="st">`</span><span class="at">%&gt;%</span><span class="st">`</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>a<span class="ot">=</span> <span class="dv">1</span> <span class="co"># alpha for prior on the PC's</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>b<span class="ot">=</span> <span class="dv">1</span> <span class="co"># beta for the prior on PC's</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># number of subjects</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co"># number of covariates</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># number from reduced dim</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">=</span> <span class="fu">rgamma</span>(<span class="dv">1</span>,<span class="at">shape =</span>a,<span class="at">rate =</span> b) <span class="co"># hyper prior for PC's</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>B <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(p<span class="sc">*</span>q,<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(lambda)), <span class="at">ncol =</span> q)<span class="co"># PC Vectors</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>z <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>q,<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>), <span class="at">ncol =</span> q)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(p,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> N, <span class="at">ncol =</span> p)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  x[,i] <span class="ot">=</span> <span class="fu">sum</span>(B[i,]<span class="sc">*</span>z<span class="sc">+</span>mu[i]) <span class="sc">+</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>stan_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N, </span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> a, </span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> b,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu =</span> mu,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> x,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> p,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">q=</span> q</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>mod_file <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">stan_model</span>(<span class="st">"bayes_stan.stan"</span>)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">vb</span>(mod_file,</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> stan_list<span class="co">#,</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># pars = c("preds","B","z")</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>                   </span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>output_tab <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">summary</span>(fit) <span class="sc">%&gt;%</span> </span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>()  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Comparing x to the predicted values</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pred matrix</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>x_pred <span class="ot">&lt;-</span>  </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>],</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">201</span><span class="sc">:</span><span class="dv">300</span>],</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">301</span><span class="sc">:</span><span class="dv">400</span>],</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">401</span><span class="sc">:</span><span class="dv">500</span>])</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>x_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>x_pred <span class="sc">%&gt;%</span> </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V5,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"covariates"</span>,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>covariates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Table of means for each covariate.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>  x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, covariates) <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(observations)) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>z_pred <span class="ot">&lt;-</span>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"z"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"z"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>])</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>z_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>z <span class="sc">%&gt;%</span> </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>z_pred <span class="sc">%&gt;%</span> </span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V2,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"latent"</span>,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>z_comp <span class="sc">%&gt;%</span> </span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>latent)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<p>This tab looks at the min amount of data reduction for this dataset.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <span class="math inline">\(z\)</span> parameters are still ordered</p>
</div>
</div>
<p>Comparing x to the predicted values</p>
<p>Table of means for each covariate.</p>
</div>
</div>
</div>
<!-- -->

</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb12" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Besian Framework + Stan + PPCA"</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "show code"</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">    smooth-scroll: true</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>Bayesian PCA and Probabilistic PCA are similar methods but known better as one name or the other in statistics or machine learning fields respectively. Bayesian PCA is used to model latent variable in hierarchical settings by drawing samples from the posterior distribution iteratively. The benefit of this method, in addition to data reduction via PCA, are two things: (1) it allows for probabilistic inference about latent variable within the data, (2) and the selection of the best components are baked into the model which can not otherwise be done using MLE or EM estimation methods. First, let us start with an overview of PCA</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="fu">### PCA</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>The goal of Principal Component Analysis (PCA) is to solely use the data to determine principal components to transform the data as a summary within lower-dimentional space. The variance of the principal components explain the full variance of the data and are often ordered by their standard deviation ultimately used to determine the number of components to retain during the reduction step. Data reduction has the consequence of information loss, but the gain of lower model complexity.</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>One way the principal components are found are by applying the spectral decomposition method. There are 3 meaningful properties to note here which are:</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="sc">\(</span>1<span class="sc">\)</span> Since the variance covariance matrix is symmetric and positive semi-definite it can be decomposed as the following:</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    Var(X)=Z^TDZ = \begin{bmatrix}z_{11}&amp;..&amp;z_{1p}\\ .&amp;.&amp;.\\z_{n1} &amp;.&amp;z_{np} \end{bmatrix} ^T\begin{bmatrix}\lambda_1\\&amp;.\\&amp;&amp;\lambda_p \end{bmatrix} \begin{bmatrix}z_{11}&amp;..&amp;z_{1p}\\ .&amp;.&amp;.\\z_{n1} &amp;.&amp;z_{np}  \end{bmatrix}</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="sc">\(</span>2<span class="sc">\)</span> the eiganvalues of the data are the variances of the principal components $B$,</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    \begin{align} </span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    Var(B) &amp;=ZVar(X)Z^T <span class="sc">\\</span>&amp;= Z(Z^TDZ)Z^T <span class="sc">\\</span> &amp;=D \end{align}</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    $$</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- --&gt;</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="sc">\(</span>3<span class="sc">\)</span> each observation in $X$, when rotated (multiplied) by the orthogonal matrix $Z$, is projected on to a line called the principal component.</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>B = ZX<span class="sc">\\</span>or<span class="sc">\\</span>X=ZB</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>Notice this does not require any probabilistic approach and is purely mathematical.</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>In the PCA and social science literature, $q&lt;p$ is usually used and the PC's that explains the most variance in the data are retained. That is, if we ordered the $q$ PC's by size of the $\lambda 's$, indexing them by $j$, then for $q =3$; $\lambda_{j=1}&gt;\lambda_{j=2}&gt;\lambda_{j=3}$. Given this is a deterministic method, if $q = p$ then all the variance of the data would be explained, thus no data reduction/information lost. This data reduction is achieved by choosing a smaller set of principal components $B_q$ and eigenvectors $Z_q$ to approximate $X$ effectively not using all of the rows of $B$. That is:</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>X_{nxp} \approx \tilde X_{nxp} = Z_{nxq}B_{qxp}, q<span class="kw">&lt;p</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a><span class="er">$$</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a><span class="ot">Essentially</span><span class="er">,</span> <span class="er">assuming</span> <span class="er">the</span> <span class="er">data</span> <span class="er">was</span> <span class="er">not</span> <span class="er">standardized,</span> <span class="er">for</span> <span class="er">each</span> <span class="er">subject</span> <span class="er">$i$</span> <span class="er">all</span> <span class="er">of</span> <span class="er">their</span> <span class="er">covariate</span> <span class="er">data</span> <span class="er">can</span> <span class="er">be</span> <span class="er">linearly</span> <span class="er">represented</span> <span class="er">as,</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a><span class="er">$$x_i</span><span class="ot">=</span><span class="st">\beta</span> <span class="er">z_i+\mu_p$$</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a><span class="ot">or</span> <span class="er">more</span> <span class="er">descriptively</span> <span class="er">for</span> <span class="er">all</span> <span class="er">data</span> <span class="er">observations,</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a><span class="er">$$</span> <span class="er">\begin{bmatrix}x_{11}&amp;..&amp;..&amp;x_{1p}\\.&amp;.</span> <span class="er">&amp;</span> <span class="er">&amp;.\\.&amp;</span> <span class="er">&amp;.</span> <span class="er">&amp;.\\x_n</span> <span class="er">&amp;.&amp;.&amp;x_{np}</span> <span class="er">\end{bmatrix}</span> <span class="ot">=</span><span class="st">\begin{bmatrix}</span> <span class="er">z_{11}&amp;..</span> <span class="er">&amp;</span> <span class="er">z_{1q}\\.&amp;.&amp;.\\z_{n1}&amp;..&amp;z_{nq}</span> <span class="er">\end{bmatrix}\begin{bmatrix}B_{11}&amp;..&amp;..&amp;B_{1p}\\.&amp;.&amp;&amp;.\\.&amp;</span> <span class="er">&amp;.&amp;.\\B_{q1}&amp;.&amp;.&amp;B_{qp}</span> <span class="er">\end{bmatrix}+\begin{bmatrix}\mu_1\\\mu_2\\.\\.\\\mu_p</span>  <span class="er">\end{bmatrix}</span> <span class="er">$$</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a><span class="ot">However</span><span class="er">,</span> <span class="er">in</span> <span class="er">standard</span> <span class="er">practice</span> <span class="er">the</span> <span class="er">covariates</span> <span class="er">are</span> <span class="er">all</span> <span class="er">standardized</span> <span class="er">before</span> <span class="er">deriving</span> <span class="er">the</span> <span class="er">PC's.</span> <span class="er">Essentially,</span> <span class="er">various</span> <span class="er">sets</span> <span class="er">of</span> <span class="er">the</span> <span class="er">Principal</span> <span class="er">components</span> <span class="er">can</span> <span class="er">then</span> <span class="er">be</span> <span class="er">further</span> <span class="er">used</span> <span class="er">to</span> <span class="er">predict</span> <span class="er">a</span> <span class="er">measure</span> <span class="er">of</span> <span class="er">interest.</span></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a><span class="ot">Here</span><span class="er">'s</span> <span class="er">an</span> <span class="er">example</span> <span class="er">retrieving</span> <span class="er">all</span> <span class="er">the</span> <span class="er">covariate</span> <span class="er">information</span> <span class="er">for</span> <span class="er">subject</span> <span class="er">1.</span> <span class="er">If</span> <span class="er">there</span> <span class="er">are</span> <span class="er">2</span> <span class="er">covariates,</span> <span class="er">then</span> <span class="er">there</span> <span class="er">are</span> <span class="er">2</span> <span class="er">PC's</span> <span class="er">and</span> <span class="er">we</span> <span class="er">assume</span> <span class="er">$q</span><span class="ot">=</span><span class="st">p$</span> <span class="er">then</span> <span class="er">for</span> <span class="er">subject</span> <span class="er">1,</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a><span class="er">$$</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a><span class="er">\begin{bmatrix}x_{11}</span> <span class="er">&amp;</span> <span class="er">x_{12}</span> <span class="er">\end{bmatrix}</span> <span class="ot">=</span> <span class="st">\begin{bmatrix}z_{11}B_{11}+z_{12}B_{21}</span><span class="er">&amp;</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a><span class="ot">z_</span><span class="er">{11}B_{12}+z_{12}B_{22}</span> </span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a> <span class="er">\end{bmatrix}</span></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a><span class="er">$$</span></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a><span class="ot">Likewise</span> <span class="er">for</span> <span class="er">subject</span> <span class="er">2,</span> <span class="er">but</span> <span class="er">with</span> <span class="er">$q</span> <span class="ot">=</span> <span class="st">1$,</span> <span class="er">then</span></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a><span class="er">$$</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a><span class="er">\begin{bmatrix}x_{21}</span> <span class="er">&amp;</span> <span class="er">x_{22}</span> <span class="er">\end{bmatrix}</span> <span class="er">\approx</span> <span class="er">\begin{bmatrix}z_{21}B_{11}</span> <span class="er">&amp;</span> <span class="er">z_{21}*B_{12}</span> </span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a> <span class="er">\end{bmatrix}</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a><span class="er">$$</span></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a><span class="ot">To</span> <span class="er">find</span> <span class="er">the</span> <span class="er">acutal</span> <span class="er">principal</span> <span class="er">components</span> <span class="er">$B$,</span> <span class="er">singular</span> <span class="er">value</span> <span class="er">decomposistion</span> <span class="er">is</span> <span class="er">used</span> <span class="er">to</span> <span class="er">determine</span> <span class="er">Ultimately,</span> <span class="er">PCA</span> <span class="er">is</span> <span class="er">used</span> <span class="er">to</span> <span class="er">reduce</span> <span class="er">the</span> <span class="er">dimensions</span> <span class="er">of</span> <span class="er">the</span> <span class="er">dataset</span> <span class="er">which</span> <span class="er">allows</span> <span class="er">for</span> <span class="er">a</span> <span class="er">less</span> <span class="er">complex</span> <span class="er">model</span> <span class="er">at</span> <span class="er">the</span> <span class="er">expense</span> <span class="er">of</span> <span class="er">information</span> <span class="er">loss.</span> <span class="er">However,</span> <span class="er">this</span> <span class="er">method</span> <span class="er">can</span> <span class="er">not</span> <span class="er">handle</span> <span class="er">missing</span> <span class="er">data,</span> <span class="er">and</span> <span class="er">is</span> <span class="er">subject</span> <span class="er">to</span> <span class="er">outliers</span> <span class="er">influencing</span> <span class="er">the</span> <span class="er">rotation</span> <span class="er">of</span> <span class="er">the</span> <span class="er">PC's.\</span></span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a><span class="er">\</span></span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a><span class="ot">How</span> <span class="er">can</span> <span class="er">we</span> <span class="er">take</span> <span class="er">a</span> <span class="er">probabilistic</span> <span class="er">approach</span> <span class="er">to</span> <span class="er">this</span> <span class="er">and</span> <span class="er">why</span> <span class="er">would</span> <span class="er">we</span> <span class="er">want</span> <span class="er">to?</span> <span class="er">Well,</span> <span class="er">researchers</span> <span class="er">are</span> <span class="er">interested</span> <span class="er">in</span> <span class="er">finding,</span> <span class="er">in</span> <span class="er">probability,</span> <span class="er">the</span> <span class="er">components</span> <span class="er">that</span> <span class="er">explain</span> <span class="er">the</span> <span class="er">most</span> <span class="er">variance</span> <span class="er">so</span> <span class="er">that</span> <span class="er">one</span> <span class="er">can</span> <span class="er">study</span> <span class="er">their</span> <span class="er">latent</span> <span class="er">effects.</span> <span class="er">At</span> <span class="er">the</span> <span class="er">inception</span> <span class="er">of</span> <span class="er">these</span> <span class="er">methods</span> <span class="er">the</span> <span class="er">computational</span> <span class="er">power</span> <span class="er">did</span> <span class="er">not</span> <span class="er">exist</span> <span class="er">and</span> <span class="er">thus</span> <span class="er">lead</span> <span class="er">the</span> <span class="er">discourse</span> <span class="er">to</span> <span class="er">find</span> <span class="er">alternative</span> <span class="er">estimations</span> <span class="er">methods</span> <span class="er">for</span> <span class="er">the</span> <span class="er">marginal</span> <span class="er">versions</span> <span class="er">of</span> <span class="er">the</span> <span class="er">probabilistic</span> <span class="er">model.</span> <span class="er">However,</span> <span class="er">we</span> <span class="er">now</span> <span class="er">have</span> <span class="er">the</span> <span class="er">computational</span> <span class="er">power</span> <span class="er">to</span> <span class="er">retain</span> <span class="er">the</span> <span class="er">full</span> <span class="er">joint</span> <span class="er">posterior</span> <span class="er">of</span> <span class="er">the</span> <span class="er">parameters.</span> <span class="er">The</span> <span class="er">PPCA/Bayesian</span> <span class="er">PCA</span> <span class="er">section</span> <span class="er">will</span> <span class="er">explain</span> <span class="er">the</span> <span class="er">method</span> <span class="er">in</span> <span class="er">detail.</span></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a><span class="ot">#</span><span class="er">##</span> <span class="er">Factor</span> <span class="er">Analysis</span></span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a><span class="ot">Historically</span><span class="er">,</span> <span class="er">Factor</span> <span class="er">Analysis</span> <span class="er">(FA)</span> <span class="er">was</span> <span class="er">very</span> <span class="er">similar</span> <span class="er">to</span> <span class="er">PCA</span> <span class="er">with</span> <span class="er">the</span> <span class="er">slight</span> <span class="er">diffence</span> <span class="er">that</span> <span class="er">an</span> <span class="er">error</span> <span class="er">term</span> <span class="er">was</span> <span class="er">introduced</span> <span class="er">into</span> <span class="er">the</span> <span class="er">model</span> <span class="er">having</span> <span class="er">a</span> <span class="er">covariance</span> <span class="er">matrix</span> <span class="er">that</span> <span class="er">allowed</span> <span class="er">for</span> <span class="er">comparritive</span> <span class="er">error</span> <span class="er">accross</span> <span class="er">individual</span> <span class="er">observations.</span> <span class="er">This</span> <span class="er">was</span> <span class="er">a</span> <span class="er">step</span> <span class="er">closer</span> <span class="er">to</span> <span class="er">a</span> <span class="er">probabilistic</span> <span class="er">framework</span> <span class="er">but</span> <span class="er">not</span> <span class="er">quiet</span> <span class="er">because</span> <span class="er">the</span> <span class="er">principal</span> <span class="er">components</span> <span class="er">or</span> <span class="er">factors</span> <span class="er">derived</span> <span class="er">from</span> <span class="er">the</span> <span class="er">covariance</span> <span class="er">matrix</span> <span class="er">were</span> <span class="er">forced</span> <span class="er">to</span> <span class="er">be</span> <span class="er">orthogonal</span> <span class="er">using</span> <span class="er">SVD</span> <span class="er">methods</span> <span class="er">as</span> <span class="er">in</span> <span class="er">PCA.</span> <span class="er">These</span> <span class="er">factors</span> <span class="er">to,</span> <span class="er">summarize</span> <span class="er">the</span> <span class="er">data</span> <span class="er">in</span> <span class="er">a</span> <span class="er">lower-dimensional</span> <span class="er">space</span> <span class="er">however</span> <span class="er">allow</span> <span class="er">for</span> <span class="er">a</span> <span class="er">distribution</span> <span class="er">on</span> <span class="er">the</span> <span class="er">latent</span> <span class="er">scores</span> <span class="er">that</span> <span class="er">multiply</span> <span class="er">the</span> <span class="er">facotors.</span> <span class="er">Additionaly,</span> <span class="er">the</span> <span class="er">number</span> <span class="er">of</span> <span class="er">factors</span> <span class="er">are</span> <span class="er">often</span> <span class="er">predefined</span> <span class="er">based</span> <span class="er">on</span> <span class="er">data</span> <span class="er">assumptions.</span> <span class="er">For</span> <span class="er">example,</span> <span class="er">if</span> <span class="er">our</span> <span class="er">data</span> <span class="er">set</span> <span class="er">contained</span> <span class="er">covariates</span> <span class="er">associated</span> <span class="er">with</span> <span class="er">social</span> <span class="er">economic</span> <span class="er">status,</span> <span class="er">and</span> <span class="er">transportation,</span> <span class="er">the</span> <span class="er">factor</span> <span class="er">analytical</span> <span class="er">approach</span> <span class="er">would</span> <span class="er">assume</span> <span class="er">the</span> <span class="er">data</span> <span class="er">could</span> <span class="er">be</span> <span class="er">summarized</span> <span class="er">with</span> <span class="er">2</span> <span class="er">components.</span> <span class="er">But,</span> <span class="er">should</span> <span class="er">there</span> <span class="er">be</span> <span class="er">an</span> <span class="er">additional</span> <span class="er">factor</span> <span class="er">that</span> <span class="er">has</span> <span class="er">an</span> <span class="er">eigenvalue</span> <span class="er">greater</span> <span class="er">than</span> <span class="er">1</span> <span class="er">then</span> <span class="er">it</span> <span class="er">could</span> <span class="er">be</span> <span class="er">considered</span> <span class="er">that</span> <span class="er">there</span> <span class="er">is</span> <span class="er">an</span> <span class="er">unnamed</span> <span class="er">factor</span> <span class="er">that</span> <span class="er">explains</span> <span class="er">an</span> <span class="er">important</span> <span class="er">structural</span> <span class="er">aspect</span> <span class="er">of</span> <span class="er">the</span> <span class="er">data.</span> <span class="er">In</span> <span class="er">conclusion,</span> <span class="er">both</span> <span class="er">PCA</span> <span class="er">and</span> <span class="er">FA</span> <span class="er">are</span> <span class="er">exploratory</span> <span class="er">methods</span> <span class="er">and</span> <span class="er">lack</span> <span class="er">probabilistic</span> <span class="er">properties</span> <span class="er">necessary</span> <span class="er">for</span> <span class="er">statistical</span> <span class="er">inference.</span> <span class="er">Furthermore,</span> <span class="er">more</span> <span class="er">contemporary</span> <span class="er">implementations</span> <span class="er">of</span> <span class="er">FA</span> <span class="er">retain</span> <span class="er">probabilistic</span> <span class="er">properties</span> <span class="er">by</span> <span class="er">reason</span> <span class="er">of</span> <span class="er">spectral</span> <span class="er">decomposition</span> <span class="er">providing</span> <span class="er">the</span> <span class="er">gaussian</span> <span class="er">approach,</span> <span class="er">and</span> <span class="er">thus</span> <span class="er">assuming</span> <span class="er">a</span> <span class="er">distribution</span> <span class="er">on</span> <span class="er">the</span> <span class="er">factors</span> <span class="er">and</span> <span class="er">latent</span> <span class="er">variables</span> <span class="er">they</span> <span class="er">emerge</span> <span class="er">orthogonal</span> <span class="er">which</span> <span class="er">is</span> <span class="er">necessary</span> <span class="er">to</span> <span class="er">map</span> <span class="er">this</span> <span class="er">latent</span> <span class="er">components</span> <span class="er">back</span> <span class="er">to</span> <span class="er">the</span> <span class="er">observed</span> <span class="er">variables.</span> <span class="er">This</span> <span class="er">is</span> <span class="er">better</span> <span class="er">explained</span> <span class="er">in</span> <span class="er">the</span> <span class="er">next</span> <span class="er">section.</span></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a><span class="ot">#</span><span class="er">##</span> <span class="er">PPCA/Bayesian</span> <span class="er">PCA</span></span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a><span class="ot">This</span> <span class="er">section</span> <span class="er">will</span> <span class="er">first</span> <span class="er">explain</span> <span class="er">the</span> <span class="er">notation</span> <span class="er">used</span> <span class="er">for</span> <span class="er">Probabilistic</span> <span class="er">Principal</span> <span class="er">Component</span> <span class="er">Analysis</span> <span class="er">(PPCA).</span> <span class="er">PPCA</span> <span class="er">is</span> <span class="er">similar</span> <span class="er">in</span> <span class="er">nature</span> <span class="er">if</span> <span class="er">not</span> <span class="er">identical</span> <span class="er">to</span> <span class="er">FA,</span> <span class="er">but</span> <span class="er">the</span> <span class="er">difference</span> <span class="er">only</span> <span class="er">appears</span> <span class="er">for</span> <span class="er">the</span> <span class="er">structure</span> <span class="er">of</span> <span class="er">the</span> <span class="er">covariance</span> <span class="er">matrix</span> <span class="er">of</span> <span class="er">the</span> <span class="er">error</span> <span class="er">terms.</span> <span class="er">FA</span> <span class="er">assumes</span> <span class="er">unique</span> <span class="er">error</span> <span class="er">and</span> <span class="er">thus</span> <span class="er">the</span> <span class="er">off</span> <span class="er">diagonals</span> <span class="er">of</span> <span class="er">the</span> <span class="er">error</span> <span class="er">terms's</span> <span class="er">covariance</span> <span class="er">matrix</span> <span class="er">are</span> <span class="er">greater</span> <span class="er">than</span> <span class="er">0</span> <span class="er">while</span> <span class="er">for</span> <span class="er">PPCA's</span> <span class="er">they</span> <span class="er">are</span> <span class="er">0.</span> <span class="er">That</span> <span class="er">is</span> <span class="er">why</span> <span class="er">it</span> <span class="er">has</span> <span class="er">the</span> <span class="er">flavor</span> <span class="er">of</span> <span class="er">PCA,</span> <span class="er">extending</span> <span class="er">it</span> <span class="er">in</span> <span class="er">a</span> <span class="er">probabilistic</span> <span class="er">setting.</span> <span class="er">Like</span> <span class="er">FA,</span> <span class="er">using</span> <span class="er">reasoning</span> <span class="er">from</span> <span class="er">spectral</span> <span class="er">decomposition,</span> <span class="er">the</span> <span class="er">model</span> <span class="er">then</span> <span class="er">minimizes</span> <span class="er">$||x-zB-\mu||</span><span class="ot">=</span><span class="st">||\epsilon</span> <span class="er">\epsilon^T||$.</span> <span class="er">According</span> <span class="er">to</span> <span class="er">PCA</span> <span class="er">literature</span> <span class="er">it</span> <span class="er">is</span> <span class="er">standard</span> <span class="er">practice</span> <span class="er">to</span> <span class="er">standardize</span> <span class="er">the</span> <span class="er">covariates</span> <span class="er">as</span> <span class="er">z</span> <span class="er">scores.</span> <span class="er">Thus,</span> <span class="er">it</span> <span class="er">is</span> <span class="er">safe</span> <span class="er">to</span> <span class="er">assume</span> <span class="er">a</span> <span class="er">standard</span> <span class="er">multivariate</span> <span class="er">normal</span> <span class="er">distribution</span> <span class="er">if</span> <span class="er">the</span> <span class="er">data</span> <span class="er">is</span> <span class="er">normalized.</span></span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a><span class="er">$$x_i</span><span class="ot">=</span><span class="st">\beta</span> <span class="er">z_i+\mu_p+\epsilon_i</span> <span class="er">\\</span> <span class="er">\mu</span> <span class="er">\sim</span> <span class="er">N(0,</span> </span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a><span class="er">\bf</span> <span class="er">I_p)</span> <span class="er">\\</span> <span class="er">\epsilon\sim</span> <span class="er">N(\bf0,\sigma^2\bf</span> <span class="er">I_p)</span>  <span class="er">$$</span></span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a><span class="ot">or</span> <span class="er">more</span> <span class="er">descriptively,</span></span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a><span class="er">$$</span> <span class="er">\begin{bmatrix}x_{11}&amp;..&amp;..&amp;x_{1p}\\.&amp;.</span> <span class="er">&amp;</span> <span class="er">&amp;.\\.&amp;</span> <span class="er">&amp;.</span> <span class="er">&amp;.\\x_n</span> <span class="er">&amp;.&amp;.&amp;x_{np}</span> <span class="er">\end{bmatrix}</span> <span class="ot">=</span><span class="st">\begin{bmatrix}</span> <span class="er">z_{11}&amp;..</span> <span class="er">&amp;</span> <span class="er">z_{1q}\\.&amp;.&amp;.\\z_{n1}&amp;..</span> <span class="er">&amp;z_{nq}</span> <span class="er">\end{bmatrix}\begin{bmatrix}B_{11}&amp;..&amp;..&amp;B_{1p}\\.&amp;.&amp;&amp;.\\.&amp;</span> <span class="er">&amp;.&amp;.\\B_{q1}&amp;.&amp;.&amp;B_{qp}</span> <span class="er">\end{bmatrix}+\begin{bmatrix}\mu_1&amp;\mu_2&amp;..\mu_p</span>  <span class="er">\end{bmatrix}+\begin{bmatrix}</span> <span class="er">\epsilon_1\\\epsilon_2\\.\\.\\</span> <span class="er">\epsilon_n</span>  <span class="er">\end{bmatrix}</span> <span class="er">$$</span></span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a><span class="ot">Given</span> <span class="er">nature</span> <span class="er">of</span> <span class="er">PCA</span> <span class="er">is</span> <span class="er">to</span> <span class="er">minimize</span> <span class="er">the</span> <span class="er">sum</span> <span class="er">of</span> <span class="er">squared</span> <span class="er">error,</span> <span class="er">the</span> <span class="er">distribution</span> <span class="er">assumed</span> <span class="er">for</span> <span class="er">$z$</span> <span class="er">is</span> <span class="er">forced</span> <span class="er">to</span> <span class="er">be</span> <span class="er">orthogonal.</span> <span class="er">We</span> <span class="er">assume</span> <span class="er">the</span> <span class="er">following</span> <span class="er">distributions</span> <span class="er">on</span> <span class="er">the</span> <span class="er">additional</span> <span class="er">parameters</span> <span class="er">and</span> <span class="er">data.</span></span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a><span class="er">$$\begin{align}</span></span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a><span class="ot">x_i</span> <span class="er">&amp;\sim</span> <span class="er">N(\mu,</span> <span class="er">\beta</span> <span class="er">\beta^T+\sigma^2</span> <span class="er">\bf</span> <span class="er">I_p),</span> <span class="er">\mu</span> <span class="er">\sim</span> <span class="er">N(0,</span> <span class="er">\bf</span> <span class="er">I_p)\\</span></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a><span class="ot">x_i</span> <span class="er">|</span> <span class="er">z_i</span> <span class="er">&amp;\sim</span> <span class="er">N(\beta</span> <span class="er">z_i,\sigma^2</span> <span class="er">\bf</span> <span class="er">I_p)\\</span></span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a><span class="ot">z_i</span> <span class="er">&amp;\sim</span> <span class="er">N(\bf</span> <span class="er">0,I_q)\\</span></span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a><span class="er">\beta_q</span> <span class="er">|</span> <span class="er">\lambda_q</span> <span class="er">&amp;\sim</span> <span class="er">N(\bf</span> <span class="er">0,\lambda^{-1}_q</span> <span class="er">*\bf</span> <span class="er">I_p)\\</span></span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a><span class="er">\lambda</span> <span class="er">&amp;\sim</span> <span class="er">Gam(a,b)</span></span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a><span class="er">\end{align}$$</span></span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a><span class="ot">:::</span> <span class="er">callout-note</span></span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a><span class="ot">Note:</span> <span class="er">$\lambda's$</span> <span class="er">are</span> <span class="er">eigenvalues</span> <span class="er">of</span> <span class="er">the</span> <span class="er">variance</span> <span class="er">of</span> <span class="er">the</span> <span class="er">data</span> <span class="er">which</span> <span class="er">are</span> <span class="er">often</span> <span class="er">used</span> <span class="er">to</span> <span class="er">determine</span> <span class="er">the</span> <span class="er">most</span> <span class="er">important</span> <span class="er">principal</span> <span class="er">components.</span> <span class="er">Also,</span> <span class="er">the</span> <span class="er">covariance</span> <span class="er">matrix</span> <span class="er">of</span> <span class="er">$\epsilon$</span> <span class="er">is</span> <span class="er">a</span> <span class="er">diagonol</span> <span class="er">matrix</span> <span class="er">marks</span> <span class="er">the</span> <span class="er">distinction</span> <span class="er">from</span> <span class="er">Factor</span> <span class="er">Analysis.</span> <span class="er">Last,</span> <span class="er">orthogonality</span> <span class="er">imerges</span> <span class="er">as</span> <span class="er">of</span> <span class="er">a</span> <span class="er">result</span> <span class="er">of</span> <span class="er">the</span> <span class="er">Gaussian</span> <span class="er">process</span> <span class="er">induced</span> <span class="er">by</span> <span class="er">reason</span> <span class="er">of</span> <span class="er">spectral</span> <span class="er">decomposition.</span></span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a><span class="ot">:::</span></span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a><span class="ot">#</span><span class="er">#</span> <span class="er">Methods</span></span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a><span class="ot">#</span><span class="er">##</span> <span class="er">Bayesian</span> <span class="er">Framework</span></span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a><span class="ot">This</span> <span class="er">section</span> <span class="er">simulates</span> <span class="er">data</span> <span class="er">based</span> <span class="er">on</span> <span class="er">previous</span> <span class="er">distributions</span> <span class="er">within</span> <span class="er">a</span> <span class="er">Bayesian</span> <span class="er">framework.</span> <span class="er">Baye's</span> <span class="er">method</span> <span class="er">allows</span> <span class="er">us</span> <span class="er">to</span> <span class="er">model</span> <span class="er">the</span> <span class="er">posterior</span> <span class="er">distribution</span> <span class="er">by</span> <span class="er">drawing</span> <span class="er">samples</span> <span class="er">from</span> <span class="er">a</span> <span class="er">proportional</span> <span class="er">prior</span> <span class="er">distribution.</span> <span class="er">Typically</span> <span class="er">in</span> <span class="er">practice</span> <span class="er">the</span> <span class="er">number</span> <span class="er">of</span> <span class="er">components</span> <span class="er">retained</span> <span class="er">are</span> <span class="er">either</span> <span class="er">the</span> <span class="er">PC</span> <span class="er">with</span> <span class="er">the</span> <span class="er">largest</span> <span class="er">eigenvalue</span> <span class="er">as</span> <span class="er">in</span> <span class="er">typically</span> <span class="er">social</span> <span class="er">science</span> <span class="er">literature,</span> <span class="er">or</span> <span class="er">for</span> <span class="er">factor</span> <span class="er">analysis</span> <span class="er">purposes,</span> <span class="er">the</span> <span class="er">PC's</span> <span class="er">with</span> <span class="er">eigenvalues</span> <span class="er">greater</span> <span class="er">than</span> <span class="er">1.</span> <span class="er">In</span> <span class="er">the</span> <span class="er">Bayesian</span> <span class="er">framework</span> <span class="er">by</span> <span class="er">setting</span> <span class="er">a</span> <span class="er">prior</span> <span class="er">on</span> <span class="er">the</span> <span class="er">PC's</span> <span class="er">variance</span> <span class="er">we</span> <span class="er">can</span> <span class="er">allow</span> <span class="er">the</span> <span class="er">model</span> <span class="er">to</span> <span class="er">choose</span> <span class="er">the</span> <span class="er">best</span> <span class="er">PC's</span> <span class="er">to</span> <span class="er">retain</span> <span class="er">as</span> <span class="er">they</span> <span class="er">are</span> <span class="er">shrunken</span> <span class="er">if</span> <span class="er">the</span> <span class="er">variance</span> <span class="er">explained</span> <span class="er">is</span> <span class="er">very</span> <span class="er">small.</span> <span class="er">The</span> <span class="er">goal</span> <span class="er">is</span> <span class="er">to</span> <span class="er">estimate</span> <span class="er">the</span> <span class="er">following</span> <span class="er">posterior</span> <span class="er">distribution.</span></span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a><span class="er">$$</span> <span class="er">P(z,\beta,\mu,\lambda,\sigma^2|x)</span> <span class="er">\propto</span> <span class="er">P(x|\beta,</span> <span class="er">z,\mu,\lambda,</span> <span class="er">\sigma^2)P(z)P(\beta|\lambda)P(\mu)P(\sigma^2)P(\lambda)$$</span></span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a><span class="ot">:::</span> <span class="er">callout-note</span></span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a><span class="ot">Note:</span> <span class="er">Factor</span> <span class="er">analysis</span> <span class="er">transformed</span> <span class="er">over</span> <span class="er">the</span> <span class="er">years</span> <span class="er">naturally</span> <span class="er">into</span> <span class="er">a</span> <span class="er">probabilistic</span> <span class="er">approach</span> <span class="er">to</span> <span class="er">data</span> <span class="er">reduction</span> <span class="er">since</span> <span class="er">it</span> <span class="er">was</span> <span class="er">more</span> <span class="er">inherently</span> <span class="er">a</span> <span class="er">statistical</span> <span class="er">method</span> <span class="er">with</span> <span class="er">the</span> <span class="er">goal</span> <span class="er">to</span> <span class="er">become</span> <span class="er">inferential</span> <span class="er">while</span> <span class="er">PCA</span> <span class="er">remained</span> <span class="er">more</span> <span class="er">of</span> <span class="er">a</span> <span class="er">machine</span> <span class="er">learning</span> <span class="er">method</span> <span class="er">with</span> <span class="er">the</span> <span class="er">goal</span> <span class="er">of</span> <span class="er">prediction.</span></span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a><span class="ot">:::</span></span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a><span class="ot">Bayesian</span> <span class="er">methods</span> <span class="er">became</span> <span class="er">more</span> <span class="er">popular</span> <span class="er">as</span> <span class="er">computational</span> <span class="er">capacity</span> <span class="er">increased</span> <span class="er">and</span> <span class="er">thus</span> <span class="er">PPCA,</span> <span class="er">Bayesian</span> <span class="er">FA,</span> <span class="er">or</span> <span class="er">Bayesian</span> <span class="er">PCA</span> <span class="er">are</span> <span class="er">virtually</span> <span class="er">synonymous</span> <span class="er">with</span> <span class="er">the</span> <span class="er">emphasis</span> <span class="er">that</span> <span class="er">Bayesian</span> <span class="er">methods</span> <span class="er">are</span> <span class="er">used</span> <span class="er">to</span> <span class="er">estimate</span> <span class="er">the</span> <span class="er">parameters.</span> <span class="er">FA</span> <span class="er">already</span> <span class="er">became</span> <span class="er">probabilistic,</span> <span class="er">and</span> <span class="er">like</span> <span class="er">PPCA,</span> <span class="er">maximum</span> <span class="er">likelihood,</span> <span class="er">or</span> <span class="er">EM</span> <span class="er">algorithm</span> <span class="er">methods</span> <span class="er">were</span> <span class="er">used</span> <span class="er">to</span> <span class="er">estimate</span> <span class="er">the</span> <span class="er">parameters.</span> <span class="er">Since</span> <span class="er">unique</span> <span class="er">error</span> <span class="er">is</span> <span class="er">used</span> <span class="er">for</span> <span class="er">FA</span> <span class="er">there</span> <span class="er">were</span> <span class="er">no</span> <span class="er">closed</span> <span class="er">form</span> <span class="er">solutions</span> <span class="er">for</span> <span class="er">parameters</span> <span class="er">in</span> <span class="er">FA</span> <span class="er">so</span> <span class="er">the</span> <span class="er">EM</span> <span class="er">algorithm</span> <span class="er">was</span> <span class="er">preferred.</span> <span class="er">Also,</span> <span class="er">while</span> <span class="er">computational</span> <span class="er">capacity</span> <span class="er">have</span> <span class="er">been</span> <span class="er">exponentially</span> <span class="er">increasing,</span> <span class="er">the</span> <span class="er">complexity</span> <span class="er">of</span> <span class="er">Bayesian</span> <span class="er">estimation</span> <span class="er">forced</span> <span class="er">researchers</span> <span class="er">to</span> <span class="er">take</span> <span class="er">marginalized</span> <span class="er">approaches</span> <span class="er">to</span> <span class="er">estimating</span> <span class="er">the</span> <span class="er">posterior</span> <span class="er">as</span> <span class="er">opposed</span> <span class="er">to</span> <span class="er">allowing</span> <span class="er">the</span> <span class="er">model</span> <span class="er">to</span> <span class="er">estimate</span> <span class="er">the</span> <span class="er">joint</span> <span class="er">distribution</span> <span class="er">of</span> <span class="er">all</span> <span class="er">the</span> <span class="er">parameters.</span> <span class="er">In</span> <span class="er">the</span> <span class="er">next</span> <span class="er">section,</span> <span class="er">I</span> <span class="er">take</span> <span class="er">advantage</span> <span class="er">of</span> <span class="er">contemporary</span> <span class="er">computing</span> <span class="er">capacity,</span> <span class="er">and</span> <span class="er">Bayesian</span> <span class="er">estimation</span> <span class="er">methods</span> <span class="er">to</span> <span class="er">build</span> <span class="er">a</span> <span class="er">PPC</span> <span class="er">model</span> <span class="er">and</span> <span class="er">analyze</span> <span class="er">the</span> <span class="er">results.</span></span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a><span class="ot">We</span> <span class="er">apply</span> <span class="er">a</span> <span class="er">Bayesian</span> <span class="er">framework</span> <span class="er">to</span> <span class="er">model</span> <span class="er">to</span> <span class="er">determine</span> <span class="er">the</span> <span class="er">conditional</span> <span class="er">probabilities,</span> <span class="er">and</span> <span class="er">lastly,</span> <span class="er">using</span> <span class="er">variational</span> <span class="er">and</span> <span class="er">MCMC</span> <span class="er">methods</span> <span class="er">to</span> <span class="er">produce</span> <span class="er">estimates</span> <span class="er">for</span> <span class="er">the</span> <span class="er">data</span> <span class="er">using</span> <span class="er">Stan.</span></span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a><span class="ot">#</span><span class="er">##</span> <span class="er">Variation</span> <span class="er">Bayes</span> <span class="er">Estimation</span> </span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a><span class="ot">Variational</span> <span class="er">estimation</span> <span class="er">is</span> <span class="er">...</span> </span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a><span class="ot">#</span><span class="er">##</span> <span class="er">Data</span> <span class="er">Simulation</span></span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a><span class="ot">#</span><span class="er">|</span> <span class="er">label:</span> <span class="er">load-packages</span></span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a><span class="ot">#</span><span class="er">|</span> <span class="er">message:</span> <span class="er">false</span></span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a><span class="ot">packages</span> <span class="er">&lt;-</span> <span class="er">c("tidyverse","patchwork","rstan")</span></span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a><span class="ot">invisible</span><span class="er">(lapply(packages,</span> <span class="er">library,</span> <span class="er">character.only</span> <span class="ot">=</span> <span class="st">T))</span></span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a><span class="er">```</span></span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a><span class="ot">:::</span> <span class="er">panel-tabset</span></span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a><span class="ot">#</span><span class="er">###</span> <span class="er">Initial</span> </span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a><span class="ot">Simulating</span> <span class="er">the</span> <span class="er">data</span></span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a><span class="ot">#</span><span class="er">|</span> <span class="er">message:</span> <span class="er">false</span></span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a><span class="ot">#</span><span class="er">|</span> <span class="er">warning:</span> <span class="er">false</span></span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a><span class="er">`%</span><span class="kw">&gt;</span>%<span class="in">` &lt;- dplyr::`</span>%&gt;%`</span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a>a= 1 # alpha for prior on the PC's</span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a>b= 1 # beta for the prior on PC's</span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a>N &lt;- 2000 # number of subjects</span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a>p &lt;- 5 # number of covariates</span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a>q &lt;- 4 # number from reduced dim</span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a>lambda = rgamma(1,shape =a,rate = b) # hyper prior for PC's</span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a>B = matrix(rnorm(p*q,mean = 0, sd = 1/sqrt(lambda)), ncol = q) # PC Vectors</span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a>z = matrix(rnorm(N*q,mean = 0, sd = 1), ncol = q)</span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a>x &lt;- matrix(nrow = N, ncol = p)</span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a>for (i in 1:p) {</span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a>  x<span class="co">[</span><span class="ot">,i</span><span class="co">]</span> = sum(B<span class="co">[</span><span class="ot">i,</span><span class="co">]</span>*z) + rnorm(N,0,1)</span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-170"><a href="#cb12-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-171"><a href="#cb12-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-172"><a href="#cb12-172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-173"><a href="#cb12-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-174"><a href="#cb12-174" aria-hidden="true" tabindex="-1"></a><span class="in">Setting up Stan code</span></span>
<span id="cb12-175"><a href="#cb12-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-178"><a href="#cb12-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-179"><a href="#cb12-179" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb12-180"><a href="#cb12-180" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb12-181"><a href="#cb12-181" aria-hidden="true" tabindex="-1"></a><span class="in">#| results: hide</span></span>
<span id="cb12-182"><a href="#cb12-182" aria-hidden="true" tabindex="-1"></a><span class="in">stan_list &lt;- list(</span></span>
<span id="cb12-183"><a href="#cb12-183" aria-hidden="true" tabindex="-1"></a><span class="in">  N = N, </span></span>
<span id="cb12-184"><a href="#cb12-184" aria-hidden="true" tabindex="-1"></a><span class="in">  a = a, </span></span>
<span id="cb12-185"><a href="#cb12-185" aria-hidden="true" tabindex="-1"></a><span class="in">  b = b,</span></span>
<span id="cb12-186"><a href="#cb12-186" aria-hidden="true" tabindex="-1"></a><span class="in">  x = x,</span></span>
<span id="cb12-187"><a href="#cb12-187" aria-hidden="true" tabindex="-1"></a><span class="in">  p = p,</span></span>
<span id="cb12-188"><a href="#cb12-188" aria-hidden="true" tabindex="-1"></a><span class="in">  q= q</span></span>
<span id="cb12-189"><a href="#cb12-189" aria-hidden="true" tabindex="-1"></a><span class="in">)</span></span>
<span id="cb12-190"><a href="#cb12-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-191"><a href="#cb12-191" aria-hidden="true" tabindex="-1"></a><span class="in">mod_file &lt;- rstan::stan_model("bayes_stan.stan")</span></span>
<span id="cb12-192"><a href="#cb12-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-193"><a href="#cb12-193" aria-hidden="true" tabindex="-1"></a><span class="in">fit &lt;- rstan::vb(mod_file,</span></span>
<span id="cb12-194"><a href="#cb12-194" aria-hidden="true" tabindex="-1"></a><span class="in">                   data = stan_list#,</span></span>
<span id="cb12-195"><a href="#cb12-195" aria-hidden="true" tabindex="-1"></a><span class="in">                  # pars = c("preds","B","z")</span></span>
<span id="cb12-196"><a href="#cb12-196" aria-hidden="true" tabindex="-1"></a><span class="in">                   </span></span>
<span id="cb12-197"><a href="#cb12-197" aria-hidden="true" tabindex="-1"></a><span class="in">                   )</span></span>
<span id="cb12-198"><a href="#cb12-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-199"><a href="#cb12-199" aria-hidden="true" tabindex="-1"></a><span class="in">output_tab &lt;- rstan::summary(fit) %&gt;% </span></span>
<span id="cb12-200"><a href="#cb12-200" aria-hidden="true" tabindex="-1"></a><span class="in">  data.frame() %&gt;%</span></span>
<span id="cb12-201"><a href="#cb12-201" aria-hidden="true" tabindex="-1"></a><span class="in">  rownames_to_column()  </span></span>
<span id="cb12-202"><a href="#cb12-202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-203"><a href="#cb12-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-206"><a href="#cb12-206" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-207"><a href="#cb12-207" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb12-208"><a href="#cb12-208" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb12-209"><a href="#cb12-209" aria-hidden="true" tabindex="-1"></a>B.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"B"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), mean)</span>
<span id="cb12-210"><a href="#cb12-210" aria-hidden="true" tabindex="-1"></a>z.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"z"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), mean)</span>
<span id="cb12-211"><a href="#cb12-211" aria-hidden="true" tabindex="-1"></a>mu.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"mu"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>), mean)</span>
<span id="cb12-212"><a href="#cb12-212" aria-hidden="true" tabindex="-1"></a>lambda.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"lambda"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>), mean)</span>
<span id="cb12-213"><a href="#cb12-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-214"><a href="#cb12-214" aria-hidden="true" tabindex="-1"></a>gplots<span class="sc">::</span><span class="fu">heatmap.2</span>(B.vb, <span class="at">col =</span> gplots<span class="sc">::</span><span class="fu">bluered</span>(<span class="dv">70</span>), <span class="at">dendrogram=</span><span class="st">'none'</span>,<span class="at">trace=</span><span class="st">'none'</span>, <span class="at">Rowv =</span> <span class="cn">FALSE</span>, <span class="at">Colv =</span> <span class="cn">FALSE</span>, <span class="at">key=</span><span class="cn">FALSE</span>)</span>
<span id="cb12-215"><a href="#cb12-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-216"><a href="#cb12-216" aria-hidden="true" tabindex="-1"></a>gplots<span class="sc">::</span><span class="fu">heatmap.2</span>(z.vb, <span class="at">col =</span> gplots<span class="sc">::</span><span class="fu">bluered</span>(<span class="dv">70</span>), <span class="at">dendrogram=</span><span class="st">'none'</span>,<span class="at">trace=</span><span class="st">'none'</span>, <span class="at">Rowv =</span> <span class="cn">FALSE</span>, <span class="at">Colv =</span> <span class="cn">FALSE</span>, <span class="at">key=</span><span class="cn">FALSE</span>)</span>
<span id="cb12-217"><a href="#cb12-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-218"><a href="#cb12-218" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-219"><a href="#cb12-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-220"><a href="#cb12-220" aria-hidden="true" tabindex="-1"></a>Comparing x to the predicted values</span>
<span id="cb12-221"><a href="#cb12-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-224"><a href="#cb12-224" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-225"><a href="#cb12-225" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb12-226"><a href="#cb12-226" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb12-227"><a href="#cb12-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-228"><a href="#cb12-228" aria-hidden="true" tabindex="-1"></a><span class="co"># pred matrix</span></span>
<span id="cb12-229"><a href="#cb12-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-230"><a href="#cb12-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-231"><a href="#cb12-231" aria-hidden="true" tabindex="-1"></a>x_pred <span class="ot">&lt;-</span>  </span>
<span id="cb12-232"><a href="#cb12-232" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb12-233"><a href="#cb12-233" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>],</span>
<span id="cb12-234"><a href="#cb12-234" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">201</span><span class="sc">:</span><span class="dv">300</span>],</span>
<span id="cb12-235"><a href="#cb12-235" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">301</span><span class="sc">:</span><span class="dv">400</span>],</span>
<span id="cb12-236"><a href="#cb12-236" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">401</span><span class="sc">:</span><span class="dv">500</span>])</span>
<span id="cb12-237"><a href="#cb12-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-238"><a href="#cb12-238" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb12-239"><a href="#cb12-239" aria-hidden="true" tabindex="-1"></a>x_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb12-240"><a href="#cb12-240" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> </span>
<span id="cb12-241"><a href="#cb12-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-242"><a href="#cb12-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb12-243"><a href="#cb12-243" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb12-244"><a href="#cb12-244" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb12-245"><a href="#cb12-245" aria-hidden="true" tabindex="-1"></a>x_pred <span class="sc">%&gt;%</span> </span>
<span id="cb12-246"><a href="#cb12-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-247"><a href="#cb12-247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-248"><a href="#cb12-248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb12-249"><a href="#cb12-249" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V5,</span>
<span id="cb12-250"><a href="#cb12-250" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"covariates"</span>,</span>
<span id="cb12-251"><a href="#cb12-251" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb12-252"><a href="#cb12-252" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-253"><a href="#cb12-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-254"><a href="#cb12-254" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb12-255"><a href="#cb12-255" aria-hidden="true" tabindex="-1"></a>x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb12-256"><a href="#cb12-256" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb12-257"><a href="#cb12-257" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb12-258"><a href="#cb12-258" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb12-259"><a href="#cb12-259" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb12-260"><a href="#cb12-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb12-261"><a href="#cb12-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>covariates)</span>
<span id="cb12-262"><a href="#cb12-262" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-263"><a href="#cb12-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-264"><a href="#cb12-264" aria-hidden="true" tabindex="-1"></a>Table of means for each covariate.</span>
<span id="cb12-265"><a href="#cb12-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-268"><a href="#cb12-268" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-269"><a href="#cb12-269" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb12-270"><a href="#cb12-270" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb12-271"><a href="#cb12-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-272"><a href="#cb12-272" aria-hidden="true" tabindex="-1"></a>  x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb12-273"><a href="#cb12-273" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, covariates) <span class="sc">%&gt;%</span> </span>
<span id="cb12-274"><a href="#cb12-274" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(observations)) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span>
<span id="cb12-275"><a href="#cb12-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-276"><a href="#cb12-276" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-277"><a href="#cb12-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-280"><a href="#cb12-280" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-281"><a href="#cb12-281" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb12-282"><a href="#cb12-282" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb12-283"><a href="#cb12-283" aria-hidden="true" tabindex="-1"></a><span class="co"># z compared to predicted z </span></span>
<span id="cb12-284"><a href="#cb12-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-285"><a href="#cb12-285" aria-hidden="true" tabindex="-1"></a>  z_pred <span class="ot">&lt;-</span>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"z"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb12-286"><a href="#cb12-286" aria-hidden="true" tabindex="-1"></a>                 output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"z"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>],</span>
<span id="cb12-287"><a href="#cb12-287" aria-hidden="true" tabindex="-1"></a>                 output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"z"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">201</span><span class="sc">:</span><span class="dv">300</span>],</span>
<span id="cb12-288"><a href="#cb12-288" aria-hidden="true" tabindex="-1"></a>                 output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"z"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">301</span><span class="sc">:</span><span class="dv">400</span>])</span>
<span id="cb12-289"><a href="#cb12-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-290"><a href="#cb12-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-291"><a href="#cb12-291" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb12-292"><a href="#cb12-292" aria-hidden="true" tabindex="-1"></a>z_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb12-293"><a href="#cb12-293" aria-hidden="true" tabindex="-1"></a>z <span class="sc">%&gt;%</span> </span>
<span id="cb12-294"><a href="#cb12-294" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-295"><a href="#cb12-295" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb12-296"><a href="#cb12-296" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb12-297"><a href="#cb12-297" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb12-298"><a href="#cb12-298" aria-hidden="true" tabindex="-1"></a>z_pred <span class="sc">%&gt;%</span> </span>
<span id="cb12-299"><a href="#cb12-299" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-300"><a href="#cb12-300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>) <span class="co">#%&gt;% </span></span>
<span id="cb12-301"><a href="#cb12-301" aria-hidden="true" tabindex="-1"></a>  <span class="co">#rename("V1"=".")</span></span>
<span id="cb12-302"><a href="#cb12-302" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-303"><a href="#cb12-303" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb12-304"><a href="#cb12-304" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V4,</span>
<span id="cb12-305"><a href="#cb12-305" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"latent"</span>,</span>
<span id="cb12-306"><a href="#cb12-306" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb12-307"><a href="#cb12-307" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-308"><a href="#cb12-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-309"><a href="#cb12-309" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb12-310"><a href="#cb12-310" aria-hidden="true" tabindex="-1"></a>z_comp <span class="sc">%&gt;%</span> </span>
<span id="cb12-311"><a href="#cb12-311" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb12-312"><a href="#cb12-312" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb12-313"><a href="#cb12-313" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb12-314"><a href="#cb12-314" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb12-315"><a href="#cb12-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb12-316"><a href="#cb12-316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>latent)</span>
<span id="cb12-317"><a href="#cb12-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-318"><a href="#cb12-318" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-319"><a href="#cb12-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-320"><a href="#cb12-320" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Using 2 PC's</span></span>
<span id="cb12-321"><a href="#cb12-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-322"><a href="#cb12-322" aria-hidden="true" tabindex="-1"></a>Since $q$ is now greater than 1, we are using a ordering function on $z$. That kind of changes the distribution from a standard normal but a positively ordered standard normal vector of $q$ scores.</span>
<span id="cb12-323"><a href="#cb12-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-324"><a href="#cb12-324" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb12-325"><a href="#cb12-325" aria-hidden="true" tabindex="-1"></a>Ordering the $z$ parameter also helps to map the predicted $z$ to the actually $z$ parameter for comparison.</span>
<span id="cb12-326"><a href="#cb12-326" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb12-327"><a href="#cb12-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-330"><a href="#cb12-330" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-331"><a href="#cb12-331" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb12-332"><a href="#cb12-332" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb12-333"><a href="#cb12-333" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: hide</span></span>
<span id="cb12-334"><a href="#cb12-334" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb12-335"><a href="#cb12-335" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-336"><a href="#cb12-336" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">%&gt;%</span><span class="st">`</span> <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="st">`</span><span class="at">%&gt;%</span><span class="st">`</span></span>
<span id="cb12-337"><a href="#cb12-337" aria-hidden="true" tabindex="-1"></a>a<span class="ot">=</span> <span class="dv">1</span> <span class="co"># alpha for prior on the PC's</span></span>
<span id="cb12-338"><a href="#cb12-338" aria-hidden="true" tabindex="-1"></a>b<span class="ot">=</span> <span class="dv">1</span> <span class="co"># beta for the prior on PC's</span></span>
<span id="cb12-339"><a href="#cb12-339" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># number of subjects</span></span>
<span id="cb12-340"><a href="#cb12-340" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co"># number of covariates</span></span>
<span id="cb12-341"><a href="#cb12-341" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># number from reduced dim</span></span>
<span id="cb12-342"><a href="#cb12-342" aria-hidden="true" tabindex="-1"></a>lambda <span class="ot">=</span> <span class="fu">rgamma</span>(<span class="dv">1</span>,<span class="at">shape =</span>a,<span class="at">rate =</span> b) <span class="co"># hyper prior for PC's</span></span>
<span id="cb12-343"><a href="#cb12-343" aria-hidden="true" tabindex="-1"></a>B <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(p<span class="sc">*</span>q,<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(lambda)), <span class="at">ncol =</span> q)<span class="co"># PC Vectors</span></span>
<span id="cb12-344"><a href="#cb12-344" aria-hidden="true" tabindex="-1"></a>z <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>q,<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>), <span class="at">ncol =</span> q)</span>
<span id="cb12-345"><a href="#cb12-345" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(p,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb12-346"><a href="#cb12-346" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> N, <span class="at">ncol =</span> p)</span>
<span id="cb12-347"><a href="#cb12-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-348"><a href="#cb12-348" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb12-349"><a href="#cb12-349" aria-hidden="true" tabindex="-1"></a>  x[,i] <span class="ot">=</span> <span class="fu">sum</span>(B[i,]<span class="sc">*</span>z<span class="sc">+</span>mu[i]) <span class="sc">+</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb12-350"><a href="#cb12-350" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-351"><a href="#cb12-351" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-352"><a href="#cb12-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-353"><a href="#cb12-353" aria-hidden="true" tabindex="-1"></a>stan_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb12-354"><a href="#cb12-354" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N, </span>
<span id="cb12-355"><a href="#cb12-355" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> a, </span>
<span id="cb12-356"><a href="#cb12-356" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> b,</span>
<span id="cb12-357"><a href="#cb12-357" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu =</span> mu,</span>
<span id="cb12-358"><a href="#cb12-358" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> x,</span>
<span id="cb12-359"><a href="#cb12-359" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> p,</span>
<span id="cb12-360"><a href="#cb12-360" aria-hidden="true" tabindex="-1"></a>  <span class="at">q=</span> q</span>
<span id="cb12-361"><a href="#cb12-361" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-362"><a href="#cb12-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-363"><a href="#cb12-363" aria-hidden="true" tabindex="-1"></a>mod_file <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">stan_model</span>(<span class="st">"bayes_stan.stan"</span>)</span>
<span id="cb12-364"><a href="#cb12-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-365"><a href="#cb12-365" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">vb</span>(mod_file,</span>
<span id="cb12-366"><a href="#cb12-366" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> stan_list<span class="co">#,</span></span>
<span id="cb12-367"><a href="#cb12-367" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># pars = c("preds","B","z")</span></span>
<span id="cb12-368"><a href="#cb12-368" aria-hidden="true" tabindex="-1"></a>                   </span>
<span id="cb12-369"><a href="#cb12-369" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb12-370"><a href="#cb12-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-371"><a href="#cb12-371" aria-hidden="true" tabindex="-1"></a>output_tab <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">summary</span>(fit) <span class="sc">%&gt;%</span> </span>
<span id="cb12-372"><a href="#cb12-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-373"><a href="#cb12-373" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>()  </span>
<span id="cb12-374"><a href="#cb12-374" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-375"><a href="#cb12-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-376"><a href="#cb12-376" aria-hidden="true" tabindex="-1"></a>Comparing x to the predicted values</span>
<span id="cb12-377"><a href="#cb12-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-380"><a href="#cb12-380" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-381"><a href="#cb12-381" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb12-382"><a href="#cb12-382" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb12-383"><a href="#cb12-383" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb12-384"><a href="#cb12-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-385"><a href="#cb12-385" aria-hidden="true" tabindex="-1"></a><span class="co"># pred matrix</span></span>
<span id="cb12-386"><a href="#cb12-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-387"><a href="#cb12-387" aria-hidden="true" tabindex="-1"></a>x_pred <span class="ot">&lt;-</span>  </span>
<span id="cb12-388"><a href="#cb12-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb12-389"><a href="#cb12-389" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>],</span>
<span id="cb12-390"><a href="#cb12-390" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">201</span><span class="sc">:</span><span class="dv">300</span>],</span>
<span id="cb12-391"><a href="#cb12-391" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">301</span><span class="sc">:</span><span class="dv">400</span>],</span>
<span id="cb12-392"><a href="#cb12-392" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">401</span><span class="sc">:</span><span class="dv">500</span>])</span>
<span id="cb12-393"><a href="#cb12-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-394"><a href="#cb12-394" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb12-395"><a href="#cb12-395" aria-hidden="true" tabindex="-1"></a>x_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb12-396"><a href="#cb12-396" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> </span>
<span id="cb12-397"><a href="#cb12-397" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-398"><a href="#cb12-398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb12-399"><a href="#cb12-399" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb12-400"><a href="#cb12-400" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb12-401"><a href="#cb12-401" aria-hidden="true" tabindex="-1"></a>x_pred <span class="sc">%&gt;%</span> </span>
<span id="cb12-402"><a href="#cb12-402" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-403"><a href="#cb12-403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-404"><a href="#cb12-404" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb12-405"><a href="#cb12-405" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V5,</span>
<span id="cb12-406"><a href="#cb12-406" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"covariates"</span>,</span>
<span id="cb12-407"><a href="#cb12-407" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb12-408"><a href="#cb12-408" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-409"><a href="#cb12-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-410"><a href="#cb12-410" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb12-411"><a href="#cb12-411" aria-hidden="true" tabindex="-1"></a>x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb12-412"><a href="#cb12-412" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb12-413"><a href="#cb12-413" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb12-414"><a href="#cb12-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb12-415"><a href="#cb12-415" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb12-416"><a href="#cb12-416" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb12-417"><a href="#cb12-417" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>covariates)</span>
<span id="cb12-418"><a href="#cb12-418" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-419"><a href="#cb12-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-420"><a href="#cb12-420" aria-hidden="true" tabindex="-1"></a>Table of means for each covariate.</span>
<span id="cb12-421"><a href="#cb12-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-424"><a href="#cb12-424" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-425"><a href="#cb12-425" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb12-426"><a href="#cb12-426" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb12-427"><a href="#cb12-427" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb12-428"><a href="#cb12-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-429"><a href="#cb12-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-430"><a href="#cb12-430" aria-hidden="true" tabindex="-1"></a>  x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb12-431"><a href="#cb12-431" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, covariates) <span class="sc">%&gt;%</span> </span>
<span id="cb12-432"><a href="#cb12-432" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(observations)) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span>
<span id="cb12-433"><a href="#cb12-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-434"><a href="#cb12-434" aria-hidden="true" tabindex="-1"></a>z_pred <span class="ot">&lt;-</span>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"z"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb12-435"><a href="#cb12-435" aria-hidden="true" tabindex="-1"></a>output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"z"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>])</span>
<span id="cb12-436"><a href="#cb12-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-437"><a href="#cb12-437" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb12-438"><a href="#cb12-438" aria-hidden="true" tabindex="-1"></a>z_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb12-439"><a href="#cb12-439" aria-hidden="true" tabindex="-1"></a>z <span class="sc">%&gt;%</span> </span>
<span id="cb12-440"><a href="#cb12-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-441"><a href="#cb12-441" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb12-442"><a href="#cb12-442" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb12-443"><a href="#cb12-443" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb12-444"><a href="#cb12-444" aria-hidden="true" tabindex="-1"></a>z_pred <span class="sc">%&gt;%</span> </span>
<span id="cb12-445"><a href="#cb12-445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-446"><a href="#cb12-446" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-447"><a href="#cb12-447" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb12-448"><a href="#cb12-448" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V2,</span>
<span id="cb12-449"><a href="#cb12-449" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"latent"</span>,</span>
<span id="cb12-450"><a href="#cb12-450" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb12-451"><a href="#cb12-451" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-452"><a href="#cb12-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-453"><a href="#cb12-453" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb12-454"><a href="#cb12-454" aria-hidden="true" tabindex="-1"></a>z_comp <span class="sc">%&gt;%</span> </span>
<span id="cb12-455"><a href="#cb12-455" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb12-456"><a href="#cb12-456" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb12-457"><a href="#cb12-457" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb12-458"><a href="#cb12-458" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb12-459"><a href="#cb12-459" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb12-460"><a href="#cb12-460" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>latent)</span>
<span id="cb12-461"><a href="#cb12-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-462"><a href="#cb12-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-463"><a href="#cb12-463" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-464"><a href="#cb12-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-465"><a href="#cb12-465" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Using p-1 PC's</span></span>
<span id="cb12-466"><a href="#cb12-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-467"><a href="#cb12-467" aria-hidden="true" tabindex="-1"></a>This tab looks at the min amount of data reduction for this dataset.</span>
<span id="cb12-468"><a href="#cb12-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-469"><a href="#cb12-469" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb12-470"><a href="#cb12-470" aria-hidden="true" tabindex="-1"></a>The $z$ parameters are still ordered</span>
<span id="cb12-471"><a href="#cb12-471" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb12-472"><a href="#cb12-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-475"><a href="#cb12-475" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-476"><a href="#cb12-476" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb12-477"><a href="#cb12-477" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb12-478"><a href="#cb12-478" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: hide</span></span>
<span id="cb12-479"><a href="#cb12-479" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb12-480"><a href="#cb12-480" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb12-481"><a href="#cb12-481" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-482"><a href="#cb12-482" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">%&gt;%</span><span class="st">`</span> <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="st">`</span><span class="at">%&gt;%</span><span class="st">`</span></span>
<span id="cb12-483"><a href="#cb12-483" aria-hidden="true" tabindex="-1"></a>a<span class="ot">=</span> <span class="dv">1</span> <span class="co"># alpha for prior on the PC's</span></span>
<span id="cb12-484"><a href="#cb12-484" aria-hidden="true" tabindex="-1"></a>b<span class="ot">=</span> <span class="dv">1</span> <span class="co"># beta for the prior on PC's</span></span>
<span id="cb12-485"><a href="#cb12-485" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># number of subjects</span></span>
<span id="cb12-486"><a href="#cb12-486" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co"># number of covariates</span></span>
<span id="cb12-487"><a href="#cb12-487" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> p<span class="dv">-1</span> <span class="co"># number from reduced dim</span></span>
<span id="cb12-488"><a href="#cb12-488" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="fu">rgamma</span>(<span class="dv">1</span>,<span class="at">shape =</span>a,<span class="at">rate =</span> b) <span class="co"># hyper prior for PC's</span></span>
<span id="cb12-489"><a href="#cb12-489" aria-hidden="true" tabindex="-1"></a>B <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(p<span class="sc">*</span>q,<span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(alpha)), <span class="at">ncol =</span> q)<span class="co"># PC Vectors</span></span>
<span id="cb12-490"><a href="#cb12-490" aria-hidden="true" tabindex="-1"></a>log_z <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(q, <span class="at">sd =</span> .<span class="dv">15</span>)<span class="co">#PC scores</span></span>
<span id="cb12-491"><a href="#cb12-491" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> <span class="fu">exp</span>(log_z) <span class="sc">%&gt;%</span> <span class="fu">sort</span>(<span class="at">decreasing =</span> F)</span>
<span id="cb12-492"><a href="#cb12-492" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> N, <span class="at">ncol =</span> p)</span>
<span id="cb12-493"><a href="#cb12-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-494"><a href="#cb12-494" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p) {</span>
<span id="cb12-495"><a href="#cb12-495" aria-hidden="true" tabindex="-1"></a>  x[,i] <span class="ot">=</span> <span class="fu">sum</span>(B[i,]<span class="sc">*</span>z) <span class="sc">+</span> <span class="fu">rnorm</span>(N,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb12-496"><a href="#cb12-496" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-497"><a href="#cb12-497" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-498"><a href="#cb12-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-499"><a href="#cb12-499" aria-hidden="true" tabindex="-1"></a>stan_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb12-500"><a href="#cb12-500" aria-hidden="true" tabindex="-1"></a>  <span class="at">N =</span> N, </span>
<span id="cb12-501"><a href="#cb12-501" aria-hidden="true" tabindex="-1"></a>  <span class="at">a =</span> a, </span>
<span id="cb12-502"><a href="#cb12-502" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> b,</span>
<span id="cb12-503"><a href="#cb12-503" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> x,</span>
<span id="cb12-504"><a href="#cb12-504" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> p,</span>
<span id="cb12-505"><a href="#cb12-505" aria-hidden="true" tabindex="-1"></a>  <span class="at">q=</span> q</span>
<span id="cb12-506"><a href="#cb12-506" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-507"><a href="#cb12-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-508"><a href="#cb12-508" aria-hidden="true" tabindex="-1"></a>mod_file <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">stan_model</span>(<span class="st">"bayes_stan.stan"</span>)</span>
<span id="cb12-509"><a href="#cb12-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-510"><a href="#cb12-510" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">vb</span>(mod_file,</span>
<span id="cb12-511"><a href="#cb12-511" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> stan_list<span class="co">#,</span></span>
<span id="cb12-512"><a href="#cb12-512" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># pars = c("preds","B","z")</span></span>
<span id="cb12-513"><a href="#cb12-513" aria-hidden="true" tabindex="-1"></a>                   </span>
<span id="cb12-514"><a href="#cb12-514" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb12-515"><a href="#cb12-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-516"><a href="#cb12-516" aria-hidden="true" tabindex="-1"></a>output_tab <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">summary</span>(fit) <span class="sc">%&gt;%</span> </span>
<span id="cb12-517"><a href="#cb12-517" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-518"><a href="#cb12-518" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>()  </span>
<span id="cb12-519"><a href="#cb12-519" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-520"><a href="#cb12-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-521"><a href="#cb12-521" aria-hidden="true" tabindex="-1"></a>Comparing x to the predicted values</span>
<span id="cb12-522"><a href="#cb12-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-525"><a href="#cb12-525" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-526"><a href="#cb12-526" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb12-527"><a href="#cb12-527" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb12-528"><a href="#cb12-528" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb12-529"><a href="#cb12-529" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb12-530"><a href="#cb12-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-531"><a href="#cb12-531" aria-hidden="true" tabindex="-1"></a><span class="co"># pred matrix</span></span>
<span id="cb12-532"><a href="#cb12-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-533"><a href="#cb12-533" aria-hidden="true" tabindex="-1"></a>x_pred <span class="ot">&lt;-</span>  </span>
<span id="cb12-534"><a href="#cb12-534" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb12-535"><a href="#cb12-535" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>],</span>
<span id="cb12-536"><a href="#cb12-536" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">201</span><span class="sc">:</span><span class="dv">300</span>],</span>
<span id="cb12-537"><a href="#cb12-537" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">301</span><span class="sc">:</span><span class="dv">400</span>],</span>
<span id="cb12-538"><a href="#cb12-538" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">401</span><span class="sc">:</span><span class="dv">500</span>])</span>
<span id="cb12-539"><a href="#cb12-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-540"><a href="#cb12-540" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb12-541"><a href="#cb12-541" aria-hidden="true" tabindex="-1"></a>x_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb12-542"><a href="#cb12-542" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> </span>
<span id="cb12-543"><a href="#cb12-543" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-544"><a href="#cb12-544" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb12-545"><a href="#cb12-545" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb12-546"><a href="#cb12-546" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb12-547"><a href="#cb12-547" aria-hidden="true" tabindex="-1"></a>x_pred <span class="sc">%&gt;%</span> </span>
<span id="cb12-548"><a href="#cb12-548" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-549"><a href="#cb12-549" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb12-550"><a href="#cb12-550" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb12-551"><a href="#cb12-551" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V5,</span>
<span id="cb12-552"><a href="#cb12-552" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"covariates"</span>,</span>
<span id="cb12-553"><a href="#cb12-553" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb12-554"><a href="#cb12-554" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-555"><a href="#cb12-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-556"><a href="#cb12-556" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb12-557"><a href="#cb12-557" aria-hidden="true" tabindex="-1"></a>x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb12-558"><a href="#cb12-558" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb12-559"><a href="#cb12-559" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb12-560"><a href="#cb12-560" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb12-561"><a href="#cb12-561" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb12-562"><a href="#cb12-562" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb12-563"><a href="#cb12-563" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>covariates)</span>
<span id="cb12-564"><a href="#cb12-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-565"><a href="#cb12-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-566"><a href="#cb12-566" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-567"><a href="#cb12-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-568"><a href="#cb12-568" aria-hidden="true" tabindex="-1"></a>Table of means for each covariate.</span>
<span id="cb12-569"><a href="#cb12-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-572"><a href="#cb12-572" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb12-573"><a href="#cb12-573" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb12-574"><a href="#cb12-574" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb12-575"><a href="#cb12-575" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb12-576"><a href="#cb12-576" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb12-577"><a href="#cb12-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-578"><a href="#cb12-578" aria-hidden="true" tabindex="-1"></a>  x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb12-579"><a href="#cb12-579" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, covariates) <span class="sc">%&gt;%</span> </span>
<span id="cb12-580"><a href="#cb12-580" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(observations)) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span>
<span id="cb12-581"><a href="#cb12-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-582"><a href="#cb12-582" aria-hidden="true" tabindex="-1"></a><span class="co"># z compared to predicted z </span></span>
<span id="cb12-583"><a href="#cb12-583" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">z =</span> z,</span>
<span id="cb12-584"><a href="#cb12-584" aria-hidden="true" tabindex="-1"></a>       <span class="at">pred_z =</span> output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"z"</span>),output_tab<span class="sc">$</span>rowname)]) <span class="sc">%&gt;%</span> </span>
<span id="cb12-585"><a href="#cb12-585" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span>
<span id="cb12-586"><a href="#cb12-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-587"><a href="#cb12-587" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb12-588"><a href="#cb12-588" aria-hidden="true" tabindex="-1"></a>:::</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<script src="Bayesian PCA_files/libs/quarto-html/zenscroll-min.js"></script>
</body></html>