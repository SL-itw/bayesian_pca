<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Bayesian PCA</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Bayesian_pca_textbook_files/libs/clipboard/clipboard.min.js"></script>
<script src="Bayesian_pca_textbook_files/libs/quarto-html/quarto.js"></script>
<script src="Bayesian_pca_textbook_files/libs/quarto-html/popper.min.js"></script>
<script src="Bayesian_pca_textbook_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Bayesian_pca_textbook_files/libs/quarto-html/anchor.min.js"></script>
<link href="Bayesian_pca_textbook_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Bayesian_pca_textbook_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Bayesian_pca_textbook_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Bayesian_pca_textbook_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Bayesian_pca_textbook_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<style>html{ scroll-behavior: smooth; }</style>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods">Methods</a>
  <ul class="collapse">
  <li><a href="#ppca" id="toc-ppca" class="nav-link" data-scroll-target="#ppca">PPCA</a></li>
  <li><a href="#data-simulation" id="toc-data-simulation" class="nav-link" data-scroll-target="#data-simulation">Data Simulation</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Bayesian PCA</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Bayesian PCA, other wise known as or with roots from factor analysis and Probabilistic PCA, is used to model latent variable in hierachical settings. The benifit of this method is as a data reduction method allowing for probabilistic inference from summarices from PCA output, estimation of complex interactions that are limited in the MLE, approach, and does well with handling missing data.</p>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<p>This section will first explain the notation used for Probabilistic Principal Component Analysis (PPCA) then apply a Bayesian framework to model to determine the conditional probabilities, and lastly, using variational and MCMC methods to produce estimates for the data using Stan.</p>
<section id="ppca" class="level3">
<h3 class="anchored" data-anchor-id="ppca">PPCA</h3>
<p>Probabilistic PCA is similar in nature if not identical to factor anlaysis. It extends the well known method of PCA in a probabilistic setting. This allows for one to determine what variables are more probable to contribute most to the component, which is a collection of all variables, as a measure of importance, or influence, holding on to more information that could help explain clustering, outliers instead of just using the mean of the collected variables reduced to one vector.</p>
<p>Let there be a design matrix <span class="math inline">\(X\)</span> that is <span class="math inline">\(n\)</span> by <span class="math inline">\(p\)</span> dimensional where <span class="math inline">\(i\)</span> indexes <span class="math inline">\(n\)</span> subjects and <span class="math inline">\(c\)</span> indexes <span class="math inline">\(p\)</span> covariates. Let <span class="math inline">\(\beta\)</span> denote a <span class="math inline">\(p\)</span> by <span class="math inline">\(q\)</span> matrix of principal components (PC) vectors <span class="math inline">\(q&lt;p\)</span> which is a set of principal components less than <span class="math inline">\(p\)</span>. In the PCA and social science literature, <span class="math inline">\(q =1\)</span> is usually used to indicate the PC that explains the most variance in the data. That is, if we ordered the <span class="math inline">\(q\)</span> PC’s by variance explained,indexing them by <span class="math inline">\(j\)</span>, then for <span class="math inline">\(q =3\)</span>, <span class="math inline">\(j=1&gt;j=2&gt;j=3\)</span> and if <span class="math inline">\(q = p\)</span> then all the variance of the data would be explain, thus no data reduction. Lastly, another aspect needed to map the projected observations back to the actual observations are the scores associated with each PC that is shared among all subjects. Let <span class="math inline">\(z_i\)</span> be a <span class="math inline">\(q\)</span> dimensional vector for each subject <span class="math inline">\(i\)</span>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note again that all subjects share the same scores but all have different PC loading values. Also, scores represent the standard deviation/rotations of the respected PC. So once again, each subject gets a value along all the PC’s and they are multiplied to the score with the mean of the covarites as.</p>
</div>
</div>
<p>For each subject <span class="math inline">\(i\)</span>,</p>
<p><span class="math display">\[x_i=\beta z_i+\mu_p\]</span></p>
<p>or more descriptively,</p>
<p><span class="math display">\[ \begin{bmatrix}x_1\\x_2\\.\\.\\x_n  \end{bmatrix} =\begin{bmatrix}B_{11}\\B_{21}\\.\\.\\B_{p1} \end{bmatrix}z_1+\begin{bmatrix}B_{12}\\B_{22}\\.\\.\\B_{p2} \end{bmatrix}z_2+...+\begin{bmatrix}B_{1n}\\B_{2n}\\.\\.\\B_{pn} \end{bmatrix}z_n+\begin{bmatrix}\mu_1\\\mu_2\\.\\.\\\mu_p  \end{bmatrix} \]</span></p>
<p>However, assuming the covariates are standardized z scores, as is done in standard practice before deriving the PC’s, we can omit the mean variable of the covariates given they are all zero:</p>
<p><span class="math display">\[x_i=\beta z_i \]</span></p>
<p>However, the probabilistic component comes in when we offset the above product of PC’s and their scores with the mean of the covariates some noise.</p>
<p><span class="math display">\[x_i=\beta z_i+\mu_p+\epsilon_i, \epsilon\sim N(\bf0,\sigma^2\bf I_p)  \]</span></p>
<p>or more descriptively,</p>
<p><span class="math display">\[ \begin{bmatrix}x_1\\x_2\\.\\.\\x_n  \end{bmatrix} =\begin{bmatrix}B_{11}\\B_{21}\\.\\.\\B_{p1} \end{bmatrix}z_1+\begin{bmatrix}B_{12}\\B_{22}\\.\\.\\B_{p2} \end{bmatrix}z_2+...+\begin{bmatrix}B_{1q}\\B_{2q}\\.\\.\\B_{pq} \end{bmatrix}z_q+\begin{bmatrix}\mu_1\\\mu_2\\.\\.\\\mu_p  \end{bmatrix}+\begin{bmatrix} \epsilon_1\\\epsilon_2\\.\\.\\ \epsilon_n  \end{bmatrix} \]</span></p>
</section>
<section id="data-simulation" class="level3">
<h3 class="anchored" data-anchor-id="data-simulation">Data Simulation</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tidyverse"</span>,<span class="st">"patchwork"</span>,<span class="st">"rstan"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(packages, library, <span class="at">character.only =</span> T))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="bayesian-framework" class="level4">
<h4 class="anchored" data-anchor-id="bayesian-framework">Bayesian Framework</h4>
<p>This section simulates data based on previous determinations for <span class="math inline">\(\beta\)</span>, <span class="math inline">\(z\)</span>, and <span class="math inline">\(mu\)</span> for varying values of <span class="math inline">\(q&lt;p\)</span>. Within a bayesian framework the goal estimate the following posterior distribution.</p>
<p><span class="math display">\[ P(z|x,\beta,\mu,\alpha) \propto P(x|\beta, z,\mu,\alpha)P(z)P(\beta|\alpha)P(\mu)\]</span> This is achieved if we assume the following distributions on the parameters and data:</p>
<p>$$</p>
<p><span class="math display">\[\begin{align}
x_i &amp;\sim N(\mu, \beta \beta^T+\sigma^2 \bf I_p),\mu \sim N(0,I_p)\\
x_i | z_i &amp;\sim N(\beta*z_i,\sigma^2 \bf I_p)\\
z_i &amp;\sim N(\bf 0,I_q)\\
\beta_q |\alpha_q &amp;\sim N(\bf 0,\alpha^{-1}_q *\bf I_p)

\end{align}\]</span> $$</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">Using 1 PC</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Using 2 PC’s</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">Using p-1 PC’s</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>Simulating the data</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">%&gt;%</span><span class="st">`</span> <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="st">`</span><span class="at">%&gt;%</span><span class="st">`</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>a<span class="ot">=</span> <span class="fl">0.001</span> <span class="co"># alpha for prior on the PC's</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>b<span class="ot">=</span> <span class="fl">0.001</span> <span class="co"># beta for the prior on PC's</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># number of subjects</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co"># number of covariates</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number from reduced dim</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span>,q)    <span class="co"># Component precisions for the two data sets</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>q,<span class="dv">0</span>,<span class="dv">1</span>),N,q)    <span class="co"># Latent components</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,p,q)   <span class="co"># The weights</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>q)  B[,j] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(p,<span class="dv">0</span>,<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(alpha[j]))</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> z <span class="sc">%*%</span> <span class="fu">t</span>(B) <span class="sc">+</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>p,<span class="dv">0</span>,<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(sigma)),N,p)  </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> N, <span class="at">p =</span> p, <span class="at">q =</span> q, <span class="at">x =</span> x, <span class="at">z=</span>z, <span class="at">a =</span> a, <span class="at">b=</span> b)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Setting up Stan code</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>mod_file <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">stan_model</span>(<span class="st">"bayes_stan.stan"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">vb</span>(mod_file,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> data</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>output_tab <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">summary</span>(fit) <span class="sc">%&gt;%</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>()  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Comparing x to the predicted values</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pred matrix</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>x_pred <span class="ot">&lt;-</span>  </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>],</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">201</span><span class="sc">:</span><span class="dv">300</span>],</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">301</span><span class="sc">:</span><span class="dv">400</span>],</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">401</span><span class="sc">:</span><span class="dv">500</span>])</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>x_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>x_pred <span class="sc">%&gt;%</span> </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V5,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"covariates"</span>,</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>covariates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Bayesian_pca_textbook_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Table of means for each covariate.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>  x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, covariates) <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(observations)) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: left;">covariates</th>
<th style="text-align: right;">mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V1</td>
<td style="text-align: right;">-0.0384601</td>
</tr>
<tr class="even">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V2</td>
<td style="text-align: right;">-0.0782719</td>
</tr>
<tr class="odd">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V3</td>
<td style="text-align: right;">-0.0959526</td>
</tr>
<tr class="even">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V4</td>
<td style="text-align: right;">-0.0239077</td>
</tr>
<tr class="odd">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V5</td>
<td style="text-align: right;">-0.0895233</td>
</tr>
<tr class="even">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V1</td>
<td style="text-align: right;">-0.0524978</td>
</tr>
<tr class="odd">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V2</td>
<td style="text-align: right;">-0.0536280</td>
</tr>
<tr class="even">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V3</td>
<td style="text-align: right;">-0.0564049</td>
</tr>
<tr class="odd">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V4</td>
<td style="text-align: right;">-0.0604901</td>
</tr>
<tr class="even">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V5</td>
<td style="text-align: right;">-0.0554780</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p>Since <span class="math inline">\(q\)</span> is now greater than 1, we should be using a ordering function on <span class="math inline">\(z\)</span>??</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ordering the <span class="math inline">\(z\)</span> parameter were removed</p>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># number from reduced dim</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span>,q)    <span class="co"># Component precisions for the two data sets</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>q,<span class="dv">0</span>,<span class="dv">1</span>),N,q)    <span class="co"># Latent components</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,p,q)   <span class="co"># The weights</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>q)  B[,j] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(p,<span class="dv">0</span>,<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(alpha[j]))</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> z <span class="sc">%*%</span> <span class="fu">t</span>(B) <span class="sc">+</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>p,<span class="dv">0</span>,<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(sigma)),N,p)  </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> N, <span class="at">p =</span> p, <span class="at">q =</span> q, <span class="at">x =</span> x, <span class="at">z=</span>z, <span class="at">a =</span> a, <span class="at">b=</span> b)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">vb</span>(mod_file,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> data</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>output_tab <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">summary</span>(fit) <span class="sc">%&gt;%</span> </span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>()  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Comparing x to the predicted values</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>z.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"z"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), mean)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>B.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"B"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), mean)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>alpha.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"alpha"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>), mean)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>gplots<span class="sc">::</span><span class="fu">heatmap.2</span>(z.vb, <span class="at">col =</span> gplots<span class="sc">::</span><span class="fu">bluered</span>(<span class="dv">70</span>), </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dendrogram=</span><span class="st">'none'</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">trace=</span><span class="st">'none'</span>, </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Rowv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Colv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">key=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Bayesian_pca_textbook_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>gplots<span class="sc">::</span><span class="fu">heatmap.2</span>(B.vb, <span class="at">col =</span> gplots<span class="sc">::</span><span class="fu">bluered</span>(<span class="dv">70</span>), </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dendrogram=</span><span class="st">'none'</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">trace=</span><span class="st">'none'</span>, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Rowv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Colv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">key=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Bayesian_pca_textbook_files/figure-html/unnamed-chunk-7-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pred matrix</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>x_pred <span class="ot">&lt;-</span>  </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>],</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">201</span><span class="sc">:</span><span class="dv">300</span>],</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">301</span><span class="sc">:</span><span class="dv">400</span>],</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">401</span><span class="sc">:</span><span class="dv">500</span>])</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>x_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> </span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>x_pred <span class="sc">%&gt;%</span> </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V5,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"covariates"</span>,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Joining, by = c("V1", "V2", "V3", "V4", "V5", "name")</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>covariates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Bayesian_pca_textbook_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Table of means for each covariate.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>  x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, covariates) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(observations)) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: left;">covariates</th>
<th style="text-align: right;">mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V1</td>
<td style="text-align: right;">0.1072481</td>
</tr>
<tr class="even">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V2</td>
<td style="text-align: right;">0.0712873</td>
</tr>
<tr class="odd">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V3</td>
<td style="text-align: right;">-0.0282100</td>
</tr>
<tr class="even">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V4</td>
<td style="text-align: right;">-0.1463868</td>
</tr>
<tr class="odd">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V5</td>
<td style="text-align: right;">0.0312842</td>
</tr>
<tr class="even">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V1</td>
<td style="text-align: right;">-0.0174155</td>
</tr>
<tr class="odd">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V2</td>
<td style="text-align: right;">-0.0157181</td>
</tr>
<tr class="even">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V3</td>
<td style="text-align: right;">-0.0131977</td>
</tr>
<tr class="odd">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V4</td>
<td style="text-align: right;">-0.0152000</td>
</tr>
<tr class="even">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V5</td>
<td style="text-align: right;">-0.0268791</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<p>This tab looks at the min amount of data reduction for this dataset.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> p<span class="dv">-1</span> <span class="co"># number from reduced dim</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span>,q)    <span class="co"># Component precisions for the two data sets</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>q,<span class="dv">0</span>,<span class="dv">1</span>),N,q)    <span class="co"># Latent components</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,p,q)   <span class="co"># The weights</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>q)  B[,j] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(p,<span class="dv">0</span>,<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(alpha[j]))</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> z <span class="sc">%*%</span> <span class="fu">t</span>(B) <span class="sc">+</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>p,<span class="dv">0</span>,<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(sigma)),N,p)  </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> N, <span class="at">p =</span> p, <span class="at">q =</span> q, <span class="at">x =</span> x, <span class="at">z=</span>z, <span class="at">a =</span> a, <span class="at">b=</span> b)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">vb</span>(mod_file,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> data</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>output_tab <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">summary</span>(fit) <span class="sc">%&gt;%</span> </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>()  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>z.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"z"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), mean)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>B.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"B"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), mean)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>alpha.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"alpha"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>), mean)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>gplots<span class="sc">::</span><span class="fu">heatmap.2</span>(z.vb, <span class="at">col =</span> gplots<span class="sc">::</span><span class="fu">bluered</span>(<span class="dv">70</span>), </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dendrogram=</span><span class="st">'none'</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">trace=</span><span class="st">'none'</span>, </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Rowv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Colv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">key=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Bayesian_pca_textbook_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>gplots<span class="sc">::</span><span class="fu">heatmap.2</span>(B.vb, <span class="at">col =</span> gplots<span class="sc">::</span><span class="fu">bluered</span>(<span class="dv">70</span>), </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dendrogram=</span><span class="st">'none'</span>,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">trace=</span><span class="st">'none'</span>, </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Rowv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Colv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">key=</span><span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Bayesian_pca_textbook_files/figure-html/unnamed-chunk-11-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Comparing x to the predicted values</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pred matrix</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>x_pred <span class="ot">&lt;-</span>  </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>],</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">201</span><span class="sc">:</span><span class="dv">300</span>],</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">301</span><span class="sc">:</span><span class="dv">400</span>],</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">401</span><span class="sc">:</span><span class="dv">500</span>])</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>x_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> </span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>x_pred <span class="sc">%&gt;%</span> </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V5,</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"covariates"</span>,</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>covariates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="Bayesian_pca_textbook_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Table of means for each covariate.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>  x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, covariates) <span class="sc">%&gt;%</span> </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(observations)) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">name</th>
<th style="text-align: left;">covariates</th>
<th style="text-align: right;">mean</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V1</td>
<td style="text-align: right;">0.0087365</td>
</tr>
<tr class="even">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V2</td>
<td style="text-align: right;">0.0285532</td>
</tr>
<tr class="odd">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V3</td>
<td style="text-align: right;">-0.0402827</td>
</tr>
<tr class="even">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V4</td>
<td style="text-align: right;">0.0553066</td>
</tr>
<tr class="odd">
<td style="text-align: left;">actual</td>
<td style="text-align: left;">V5</td>
<td style="text-align: right;">0.2409764</td>
</tr>
<tr class="even">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V1</td>
<td style="text-align: right;">0.0897647</td>
</tr>
<tr class="odd">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V2</td>
<td style="text-align: right;">0.0941170</td>
</tr>
<tr class="even">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V3</td>
<td style="text-align: right;">0.1002281</td>
</tr>
<tr class="odd">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V4</td>
<td style="text-align: right;">0.1025836</td>
</tr>
<tr class="even">
<td style="text-align: left;">predicted</td>
<td style="text-align: left;">V5</td>
<td style="text-align: right;">0.0851220</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<!-- -->

</section>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb18" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Bayesian PCA"</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "show code"</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">    smooth-scroll: true</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>Bayesian PCA, other wise known as or with roots from factor analysis and Probabilistic PCA, is used to model latent variable in hierachical settings. The benifit of this method is as a data reduction method allowing for probabilistic inference from summarices from PCA output, estimation of complex interactions that are limited in the MLE, approach, and does well with handling missing data.</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="fu">## Methods</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>This section will first explain the notation used for Probabilistic Principal Component Analysis (PPCA) then apply a Bayesian framework to model to determine the conditional probabilities, and lastly, using variational and MCMC methods to produce estimates for the data using Stan.</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="fu">### PPCA</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>Probabilistic PCA is similar in nature if not identical to factor anlaysis. It extends the well known method of PCA in a probabilistic setting. This allows for one to determine what variables are more probable to contribute most to the component, which is a collection of all variables, as a measure of importance, or influence, holding on to more information that could help explain clustering, outliers instead of just using the mean of the collected variables reduced to one vector.</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>Let there be a design matrix $X$ that is $n$ by $p$ dimensional where $i$ indexes $n$ subjects and $c$ indexes $p$ covariates. Let $\beta$ denote a $p$ by $q$ matrix of principal components (PC) vectors $q&lt;p$ which is a set of principal components less than $p$. In the PCA and social science literature, $q =1$ is usually used to indicate the PC that explains the most variance in the data. That is, if we ordered the $q$ PC's by variance explained,indexing them by $j$, then for $q =3$, $j=1&gt;j=2&gt;j=3$ and if $q = p$ then all the variance of the data would be explain, thus no data reduction. Lastly, another aspect needed to map the projected observations back to the actual observations are the scores associated with each PC that is shared among all subjects. Let $z_i$ be a $q$ dimensional vector for each subject $i$.</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>Note again that all subjects share the same scores but all have different PC loading values. Also, scores represent the standard deviation/rotations of the respected PC. So once again, each subject gets a value along all the PC's and they are multiplied to the score with the mean of the covarites as.</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>For each subject $i$,</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>$$x_i=\beta z_i+\mu_p$$</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>or more descriptively,</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>$$ \begin{bmatrix}x_1<span class="sc">\\</span>x_2<span class="sc">\\</span>.<span class="sc">\\</span>.<span class="sc">\\</span>x_n  \end{bmatrix} =\begin{bmatrix}B_{11}<span class="sc">\\</span>B_{21}<span class="sc">\\</span>.<span class="sc">\\</span>.<span class="sc">\\</span>B_{p1} \end{bmatrix}z_1+\begin{bmatrix}B_{12}<span class="sc">\\</span>B_{22}<span class="sc">\\</span>.<span class="sc">\\</span>.<span class="sc">\\</span>B_{p2} \end{bmatrix}z_2+...+\begin{bmatrix}B_{1n}<span class="sc">\\</span>B_{2n}<span class="sc">\\</span>.<span class="sc">\\</span>.<span class="sc">\\</span>B_{pn} \end{bmatrix}z_n+\begin{bmatrix}\mu_1<span class="sc">\\</span>\mu_2<span class="sc">\\</span>.<span class="sc">\\</span>.<span class="sc">\\</span>\mu_p  \end{bmatrix} $$</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>However, assuming the covariates are standardized z scores, as is done in standard practice before deriving the PC's, we can omit the mean variable of the covariates given they are all zero: </span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>$$x_i=\beta z_i $$ </span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>However, the probabilistic component comes in when we offset the above product of PC's and their scores with the mean of the covariates some noise. </span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>$$x_i=\beta z_i+\mu_p+\epsilon_i, \epsilon\sim N(\bf0,\sigma^2\bf I_p)  $$</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>or more descriptively,</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>$$ \begin{bmatrix}x_1<span class="sc">\\</span>x_2<span class="sc">\\</span>.<span class="sc">\\</span>.<span class="sc">\\</span>x_n  \end{bmatrix} =\begin{bmatrix}B_{11}<span class="sc">\\</span>B_{21}<span class="sc">\\</span>.<span class="sc">\\</span>.<span class="sc">\\</span>B_{p1} \end{bmatrix}z_1+\begin{bmatrix}B_{12}<span class="sc">\\</span>B_{22}<span class="sc">\\</span>.<span class="sc">\\</span>.<span class="sc">\\</span>B_{p2} \end{bmatrix}z_2+...+\begin{bmatrix}B_{1q}<span class="sc">\\</span>B_{2q}<span class="sc">\\</span>.<span class="sc">\\</span>.<span class="sc">\\</span>B_{pq} \end{bmatrix}z_q+\begin{bmatrix}\mu_1<span class="sc">\\</span>\mu_2<span class="sc">\\</span>.<span class="sc">\\</span>.<span class="sc">\\</span>\mu_p  \end{bmatrix}+\begin{bmatrix} \epsilon_1<span class="sc">\\</span>\epsilon_2<span class="sc">\\</span>.<span class="sc">\\</span>.<span class="sc">\\</span> \epsilon_n  \end{bmatrix} $$</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data Simulation </span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-packages</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"tidyverse"</span>,<span class="st">"patchwork"</span>,<span class="st">"rstan"</span>)</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(packages, library, <span class="at">character.only =</span> T))</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Bayesian Framework</span></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>This section simulates data based on previous determinations for $\beta$, $z$, and $mu$ for varying values of $q&lt;p$. Within a bayesian framework the goal estimate the following posterior distribution. </span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>$$ P(z|x,\beta,\mu,\alpha) \propto P(x|\beta, z,\mu,\alpha)P(z)P(\beta|\alpha)P(\mu)$$</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>This is achieved if we assume the following distributions on the parameters and data:</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>\begin{align}</span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>x_i &amp;\sim N(\mu, \beta \beta^T+\sigma^2 \bf I_p),\mu \sim N(0,I_p)<span class="sc">\\</span></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>x_i | z_i &amp;\sim N(\beta*z_i,\sigma^2 \bf I_p)<span class="sc">\\</span></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>z_i &amp;\sim N(\bf 0,I_q)<span class="sc">\\</span></span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>\beta_q |\alpha_q &amp;\sim N(\bf 0,\alpha^{-1}_q *\bf I_p)</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>\end{align}</span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>::: panel-tabset</span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a><span class="fu">####  Using 1 PC</span></span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>Simulating the data</span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">%&gt;%</span><span class="st">`</span> <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="st">`</span><span class="at">%&gt;%</span><span class="st">`</span></span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>a<span class="ot">=</span> <span class="fl">0.001</span> <span class="co"># alpha for prior on the PC's</span></span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>b<span class="ot">=</span> <span class="fl">0.001</span> <span class="co"># beta for the prior on PC's</span></span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="co"># number of subjects</span></span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co"># number of covariates</span></span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># number from reduced dim</span></span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span>,q)    <span class="co"># Component precisions for the two data sets</span></span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>q,<span class="dv">0</span>,<span class="dv">1</span>),N,q)    <span class="co"># Latent components</span></span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,p,q)   <span class="co"># The weights</span></span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>q)  B[,j] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(p,<span class="dv">0</span>,<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(alpha[j]))</span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> z <span class="sc">%*%</span> <span class="fu">t</span>(B) <span class="sc">+</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>p,<span class="dv">0</span>,<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(sigma)),N,p)  </span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> N, <span class="at">p =</span> p, <span class="at">q =</span> q, <span class="at">x =</span> x, <span class="at">z=</span>z, <span class="at">a =</span> a, <span class="at">b=</span> b)</span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a>Setting up Stan code</span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: hide</span></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a>mod_file <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">stan_model</span>(<span class="st">"bayes_stan.stan"</span>)</span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">vb</span>(mod_file,</span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> data</span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a>output_tab <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">summary</span>(fit) <span class="sc">%&gt;%</span> </span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-126"><a href="#cb18-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>()  </span>
<span id="cb18-127"><a href="#cb18-127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-128"><a href="#cb18-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-129"><a href="#cb18-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-130"><a href="#cb18-130" aria-hidden="true" tabindex="-1"></a>Comparing x to the predicted values</span>
<span id="cb18-131"><a href="#cb18-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-134"><a href="#cb18-134" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-135"><a href="#cb18-135" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb18-136"><a href="#cb18-136" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb18-137"><a href="#cb18-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-138"><a href="#cb18-138" aria-hidden="true" tabindex="-1"></a><span class="co"># pred matrix</span></span>
<span id="cb18-139"><a href="#cb18-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-140"><a href="#cb18-140" aria-hidden="true" tabindex="-1"></a>x_pred <span class="ot">&lt;-</span>  </span>
<span id="cb18-141"><a href="#cb18-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb18-142"><a href="#cb18-142" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>],</span>
<span id="cb18-143"><a href="#cb18-143" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">201</span><span class="sc">:</span><span class="dv">300</span>],</span>
<span id="cb18-144"><a href="#cb18-144" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">301</span><span class="sc">:</span><span class="dv">400</span>],</span>
<span id="cb18-145"><a href="#cb18-145" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">401</span><span class="sc">:</span><span class="dv">500</span>])</span>
<span id="cb18-146"><a href="#cb18-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-147"><a href="#cb18-147" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb18-148"><a href="#cb18-148" aria-hidden="true" tabindex="-1"></a>x_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb18-149"><a href="#cb18-149" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> </span>
<span id="cb18-150"><a href="#cb18-150" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb18-151"><a href="#cb18-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb18-152"><a href="#cb18-152" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb18-153"><a href="#cb18-153" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb18-154"><a href="#cb18-154" aria-hidden="true" tabindex="-1"></a>x_pred <span class="sc">%&gt;%</span> </span>
<span id="cb18-155"><a href="#cb18-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb18-156"><a href="#cb18-156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-157"><a href="#cb18-157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb18-158"><a href="#cb18-158" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V5,</span>
<span id="cb18-159"><a href="#cb18-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"covariates"</span>,</span>
<span id="cb18-160"><a href="#cb18-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb18-161"><a href="#cb18-161" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-162"><a href="#cb18-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-163"><a href="#cb18-163" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb18-164"><a href="#cb18-164" aria-hidden="true" tabindex="-1"></a>x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb18-165"><a href="#cb18-165" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb18-166"><a href="#cb18-166" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb18-167"><a href="#cb18-167" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb18-168"><a href="#cb18-168" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb18-169"><a href="#cb18-169" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb18-170"><a href="#cb18-170" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>covariates)</span>
<span id="cb18-171"><a href="#cb18-171" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-172"><a href="#cb18-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-173"><a href="#cb18-173" aria-hidden="true" tabindex="-1"></a>Table of means for each covariate. </span>
<span id="cb18-174"><a href="#cb18-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-177"><a href="#cb18-177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-178"><a href="#cb18-178" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb18-179"><a href="#cb18-179" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb18-180"><a href="#cb18-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-181"><a href="#cb18-181" aria-hidden="true" tabindex="-1"></a>  x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb18-182"><a href="#cb18-182" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, covariates) <span class="sc">%&gt;%</span> </span>
<span id="cb18-183"><a href="#cb18-183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(observations)) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span>
<span id="cb18-184"><a href="#cb18-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-185"><a href="#cb18-185" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-186"><a href="#cb18-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-187"><a href="#cb18-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-188"><a href="#cb18-188" aria-hidden="true" tabindex="-1"></a><span class="fu">####  Using 2 PC's</span></span>
<span id="cb18-189"><a href="#cb18-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-190"><a href="#cb18-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-191"><a href="#cb18-191" aria-hidden="true" tabindex="-1"></a>Since $q$ is now greater than 1, we should be using a ordering function on $z$??</span>
<span id="cb18-192"><a href="#cb18-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-193"><a href="#cb18-193" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb18-194"><a href="#cb18-194" aria-hidden="true" tabindex="-1"></a>Ordering the $z$ parameter were removed</span>
<span id="cb18-195"><a href="#cb18-195" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb18-196"><a href="#cb18-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-197"><a href="#cb18-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-200"><a href="#cb18-200" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-201"><a href="#cb18-201" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb18-202"><a href="#cb18-202" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb18-203"><a href="#cb18-203" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: hide</span></span>
<span id="cb18-204"><a href="#cb18-204" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-205"><a href="#cb18-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-206"><a href="#cb18-206" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># number from reduced dim</span></span>
<span id="cb18-207"><a href="#cb18-207" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span>,q)    <span class="co"># Component precisions for the two data sets</span></span>
<span id="cb18-208"><a href="#cb18-208" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>q,<span class="dv">0</span>,<span class="dv">1</span>),N,q)    <span class="co"># Latent components</span></span>
<span id="cb18-209"><a href="#cb18-209" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,p,q)   <span class="co"># The weights</span></span>
<span id="cb18-210"><a href="#cb18-210" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>q)  B[,j] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(p,<span class="dv">0</span>,<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(alpha[j]))</span>
<span id="cb18-211"><a href="#cb18-211" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> z <span class="sc">%*%</span> <span class="fu">t</span>(B) <span class="sc">+</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>p,<span class="dv">0</span>,<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(sigma)),N,p)  </span>
<span id="cb18-212"><a href="#cb18-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-213"><a href="#cb18-213" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> N, <span class="at">p =</span> p, <span class="at">q =</span> q, <span class="at">x =</span> x, <span class="at">z=</span>z, <span class="at">a =</span> a, <span class="at">b=</span> b)</span>
<span id="cb18-214"><a href="#cb18-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-215"><a href="#cb18-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-216"><a href="#cb18-216" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">vb</span>(mod_file,</span>
<span id="cb18-217"><a href="#cb18-217" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> data</span>
<span id="cb18-218"><a href="#cb18-218" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb18-219"><a href="#cb18-219" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb18-220"><a href="#cb18-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-221"><a href="#cb18-221" aria-hidden="true" tabindex="-1"></a>output_tab <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">summary</span>(fit) <span class="sc">%&gt;%</span> </span>
<span id="cb18-222"><a href="#cb18-222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-223"><a href="#cb18-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>()  </span>
<span id="cb18-224"><a href="#cb18-224" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-225"><a href="#cb18-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-226"><a href="#cb18-226" aria-hidden="true" tabindex="-1"></a>Comparing x to the predicted values</span>
<span id="cb18-227"><a href="#cb18-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-230"><a href="#cb18-230" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-231"><a href="#cb18-231" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb18-232"><a href="#cb18-232" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb18-233"><a href="#cb18-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-234"><a href="#cb18-234" aria-hidden="true" tabindex="-1"></a>z.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"z"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), mean)</span>
<span id="cb18-235"><a href="#cb18-235" aria-hidden="true" tabindex="-1"></a>B.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"B"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), mean)</span>
<span id="cb18-236"><a href="#cb18-236" aria-hidden="true" tabindex="-1"></a>alpha.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"alpha"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>), mean)</span>
<span id="cb18-237"><a href="#cb18-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-238"><a href="#cb18-238" aria-hidden="true" tabindex="-1"></a>gplots<span class="sc">::</span><span class="fu">heatmap.2</span>(z.vb, <span class="at">col =</span> gplots<span class="sc">::</span><span class="fu">bluered</span>(<span class="dv">70</span>), </span>
<span id="cb18-239"><a href="#cb18-239" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dendrogram=</span><span class="st">'none'</span>,</span>
<span id="cb18-240"><a href="#cb18-240" aria-hidden="true" tabindex="-1"></a>                  <span class="at">trace=</span><span class="st">'none'</span>, </span>
<span id="cb18-241"><a href="#cb18-241" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Rowv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb18-242"><a href="#cb18-242" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Colv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb18-243"><a href="#cb18-243" aria-hidden="true" tabindex="-1"></a>                  <span class="at">key=</span><span class="cn">FALSE</span>)</span>
<span id="cb18-244"><a href="#cb18-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-245"><a href="#cb18-245" aria-hidden="true" tabindex="-1"></a>gplots<span class="sc">::</span><span class="fu">heatmap.2</span>(B.vb, <span class="at">col =</span> gplots<span class="sc">::</span><span class="fu">bluered</span>(<span class="dv">70</span>), </span>
<span id="cb18-246"><a href="#cb18-246" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dendrogram=</span><span class="st">'none'</span>,</span>
<span id="cb18-247"><a href="#cb18-247" aria-hidden="true" tabindex="-1"></a>                  <span class="at">trace=</span><span class="st">'none'</span>, </span>
<span id="cb18-248"><a href="#cb18-248" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Rowv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb18-249"><a href="#cb18-249" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Colv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb18-250"><a href="#cb18-250" aria-hidden="true" tabindex="-1"></a>                  <span class="at">key=</span><span class="cn">FALSE</span>)</span>
<span id="cb18-251"><a href="#cb18-251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-252"><a href="#cb18-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-253"><a href="#cb18-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-256"><a href="#cb18-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-257"><a href="#cb18-257" aria-hidden="true" tabindex="-1"></a><span class="co"># pred matrix</span></span>
<span id="cb18-258"><a href="#cb18-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-259"><a href="#cb18-259" aria-hidden="true" tabindex="-1"></a>x_pred <span class="ot">&lt;-</span>  </span>
<span id="cb18-260"><a href="#cb18-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb18-261"><a href="#cb18-261" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>],</span>
<span id="cb18-262"><a href="#cb18-262" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">201</span><span class="sc">:</span><span class="dv">300</span>],</span>
<span id="cb18-263"><a href="#cb18-263" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">301</span><span class="sc">:</span><span class="dv">400</span>],</span>
<span id="cb18-264"><a href="#cb18-264" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">401</span><span class="sc">:</span><span class="dv">500</span>])</span>
<span id="cb18-265"><a href="#cb18-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-266"><a href="#cb18-266" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb18-267"><a href="#cb18-267" aria-hidden="true" tabindex="-1"></a>x_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb18-268"><a href="#cb18-268" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> </span>
<span id="cb18-269"><a href="#cb18-269" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb18-270"><a href="#cb18-270" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb18-271"><a href="#cb18-271" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb18-272"><a href="#cb18-272" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb18-273"><a href="#cb18-273" aria-hidden="true" tabindex="-1"></a>x_pred <span class="sc">%&gt;%</span> </span>
<span id="cb18-274"><a href="#cb18-274" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb18-275"><a href="#cb18-275" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-276"><a href="#cb18-276" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb18-277"><a href="#cb18-277" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V5,</span>
<span id="cb18-278"><a href="#cb18-278" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"covariates"</span>,</span>
<span id="cb18-279"><a href="#cb18-279" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb18-280"><a href="#cb18-280" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-281"><a href="#cb18-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-282"><a href="#cb18-282" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb18-283"><a href="#cb18-283" aria-hidden="true" tabindex="-1"></a>x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb18-284"><a href="#cb18-284" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb18-285"><a href="#cb18-285" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb18-286"><a href="#cb18-286" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb18-287"><a href="#cb18-287" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb18-288"><a href="#cb18-288" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb18-289"><a href="#cb18-289" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>covariates)</span>
<span id="cb18-290"><a href="#cb18-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-291"><a href="#cb18-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-292"><a href="#cb18-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-293"><a href="#cb18-293" aria-hidden="true" tabindex="-1"></a>Table of means for each covariate. </span>
<span id="cb18-294"><a href="#cb18-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-297"><a href="#cb18-297" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-298"><a href="#cb18-298" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb18-299"><a href="#cb18-299" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb18-300"><a href="#cb18-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-301"><a href="#cb18-301" aria-hidden="true" tabindex="-1"></a>  x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb18-302"><a href="#cb18-302" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, covariates) <span class="sc">%&gt;%</span> </span>
<span id="cb18-303"><a href="#cb18-303" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(observations)) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span>
<span id="cb18-304"><a href="#cb18-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-305"><a href="#cb18-305" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-306"><a href="#cb18-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-307"><a href="#cb18-307" aria-hidden="true" tabindex="-1"></a><span class="fu">####  Using p-1 PC's</span></span>
<span id="cb18-308"><a href="#cb18-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-309"><a href="#cb18-309" aria-hidden="true" tabindex="-1"></a>This tab looks at the min amount of data reduction for this dataset. </span>
<span id="cb18-310"><a href="#cb18-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-311"><a href="#cb18-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-314"><a href="#cb18-314" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-315"><a href="#cb18-315" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb18-316"><a href="#cb18-316" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb18-317"><a href="#cb18-317" aria-hidden="true" tabindex="-1"></a><span class="co">#| results: hide</span></span>
<span id="cb18-318"><a href="#cb18-318" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-319"><a href="#cb18-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-320"><a href="#cb18-320" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> p<span class="dv">-1</span> <span class="co"># number from reduced dim</span></span>
<span id="cb18-321"><a href="#cb18-321" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span>,q)    <span class="co"># Component precisions for the two data sets</span></span>
<span id="cb18-322"><a href="#cb18-322" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span><span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>q,<span class="dv">0</span>,<span class="dv">1</span>),N,q)    <span class="co"># Latent components</span></span>
<span id="cb18-323"><a href="#cb18-323" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>,p,q)   <span class="co"># The weights</span></span>
<span id="cb18-324"><a href="#cb18-324" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>q)  B[,j] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(p,<span class="dv">0</span>,<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(alpha[j]))</span>
<span id="cb18-325"><a href="#cb18-325" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> z <span class="sc">%*%</span> <span class="fu">t</span>(B) <span class="sc">+</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(N<span class="sc">*</span>p,<span class="dv">0</span>,<span class="dv">1</span><span class="sc">/</span><span class="fu">sqrt</span>(sigma)),N,p)  </span>
<span id="cb18-326"><a href="#cb18-326" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> N, <span class="at">p =</span> p, <span class="at">q =</span> q, <span class="at">x =</span> x, <span class="at">z=</span>z, <span class="at">a =</span> a, <span class="at">b=</span> b)</span>
<span id="cb18-327"><a href="#cb18-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-328"><a href="#cb18-328" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">vb</span>(mod_file,</span>
<span id="cb18-329"><a href="#cb18-329" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> data</span>
<span id="cb18-330"><a href="#cb18-330" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb18-331"><a href="#cb18-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-332"><a href="#cb18-332" aria-hidden="true" tabindex="-1"></a>output_tab <span class="ot">&lt;-</span> rstan<span class="sc">::</span><span class="fu">summary</span>(fit) <span class="sc">%&gt;%</span> </span>
<span id="cb18-333"><a href="#cb18-333" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-334"><a href="#cb18-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>()  </span>
<span id="cb18-335"><a href="#cb18-335" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-336"><a href="#cb18-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-339"><a href="#cb18-339" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-340"><a href="#cb18-340" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb18-341"><a href="#cb18-341" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb18-342"><a href="#cb18-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-343"><a href="#cb18-343" aria-hidden="true" tabindex="-1"></a>z.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"z"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), mean)</span>
<span id="cb18-344"><a href="#cb18-344" aria-hidden="true" tabindex="-1"></a>B.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"B"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>), mean)</span>
<span id="cb18-345"><a href="#cb18-345" aria-hidden="true" tabindex="-1"></a>alpha.vb <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">extract</span>(fit,<span class="st">"alpha"</span>)[[<span class="dv">1</span>]], <span class="fu">c</span>(<span class="dv">2</span>), mean)</span>
<span id="cb18-346"><a href="#cb18-346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-347"><a href="#cb18-347" aria-hidden="true" tabindex="-1"></a>gplots<span class="sc">::</span><span class="fu">heatmap.2</span>(z.vb, <span class="at">col =</span> gplots<span class="sc">::</span><span class="fu">bluered</span>(<span class="dv">70</span>), </span>
<span id="cb18-348"><a href="#cb18-348" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dendrogram=</span><span class="st">'none'</span>,</span>
<span id="cb18-349"><a href="#cb18-349" aria-hidden="true" tabindex="-1"></a>                  <span class="at">trace=</span><span class="st">'none'</span>, </span>
<span id="cb18-350"><a href="#cb18-350" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Rowv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb18-351"><a href="#cb18-351" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Colv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb18-352"><a href="#cb18-352" aria-hidden="true" tabindex="-1"></a>                  <span class="at">key=</span><span class="cn">FALSE</span>)</span>
<span id="cb18-353"><a href="#cb18-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-354"><a href="#cb18-354" aria-hidden="true" tabindex="-1"></a>gplots<span class="sc">::</span><span class="fu">heatmap.2</span>(B.vb, <span class="at">col =</span> gplots<span class="sc">::</span><span class="fu">bluered</span>(<span class="dv">70</span>), </span>
<span id="cb18-355"><a href="#cb18-355" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dendrogram=</span><span class="st">'none'</span>,</span>
<span id="cb18-356"><a href="#cb18-356" aria-hidden="true" tabindex="-1"></a>                  <span class="at">trace=</span><span class="st">'none'</span>, </span>
<span id="cb18-357"><a href="#cb18-357" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Rowv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb18-358"><a href="#cb18-358" aria-hidden="true" tabindex="-1"></a>                  <span class="at">Colv =</span> <span class="cn">FALSE</span>, </span>
<span id="cb18-359"><a href="#cb18-359" aria-hidden="true" tabindex="-1"></a>                  <span class="at">key=</span><span class="cn">FALSE</span>)</span>
<span id="cb18-360"><a href="#cb18-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-361"><a href="#cb18-361" aria-hidden="true" tabindex="-1"></a>Comparing x to the predicted values</span>
<span id="cb18-362"><a href="#cb18-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-365"><a href="#cb18-365" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-366"><a href="#cb18-366" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb18-367"><a href="#cb18-367" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb18-368"><a href="#cb18-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-369"><a href="#cb18-369" aria-hidden="true" tabindex="-1"></a><span class="co"># pred matrix</span></span>
<span id="cb18-370"><a href="#cb18-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-371"><a href="#cb18-371" aria-hidden="true" tabindex="-1"></a>x_pred <span class="ot">&lt;-</span>  </span>
<span id="cb18-372"><a href="#cb18-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cbind</span>(output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>],</span>
<span id="cb18-373"><a href="#cb18-373" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">101</span><span class="sc">:</span><span class="dv">200</span>],</span>
<span id="cb18-374"><a href="#cb18-374" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">201</span><span class="sc">:</span><span class="dv">300</span>],</span>
<span id="cb18-375"><a href="#cb18-375" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">301</span><span class="sc">:</span><span class="dv">400</span>],</span>
<span id="cb18-376"><a href="#cb18-376" aria-hidden="true" tabindex="-1"></a>        output_tab<span class="sc">$</span>summary.mean[<span class="fu">grepl</span>(<span class="fu">c</span>(<span class="st">"preds"</span>),output_tab<span class="sc">$</span>rowname)][<span class="dv">401</span><span class="sc">:</span><span class="dv">500</span>])</span>
<span id="cb18-377"><a href="#cb18-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-378"><a href="#cb18-378" aria-hidden="true" tabindex="-1"></a><span class="co"># creating combine variables</span></span>
<span id="cb18-379"><a href="#cb18-379" aria-hidden="true" tabindex="-1"></a>x_comp <span class="ot">&lt;-</span> <span class="fu">full_join</span>(</span>
<span id="cb18-380"><a href="#cb18-380" aria-hidden="true" tabindex="-1"></a>x <span class="sc">%&gt;%</span> </span>
<span id="cb18-381"><a href="#cb18-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb18-382"><a href="#cb18-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"actual"</span>)<span class="co"># %&gt;% </span></span>
<span id="cb18-383"><a href="#cb18-383" aria-hidden="true" tabindex="-1"></a>  <span class="co">#mutate_at(vars(V1:V5),~scale(.,scale = T))</span></span>
<span id="cb18-384"><a href="#cb18-384" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb18-385"><a href="#cb18-385" aria-hidden="true" tabindex="-1"></a>x_pred <span class="sc">%&gt;%</span> </span>
<span id="cb18-386"><a href="#cb18-386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb18-387"><a href="#cb18-387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">name =</span> <span class="st">"predicted"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-388"><a href="#cb18-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb18-389"><a href="#cb18-389" aria-hidden="true" tabindex="-1"></a>    V1<span class="sc">:</span>V5,</span>
<span id="cb18-390"><a href="#cb18-390" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">"covariates"</span>,</span>
<span id="cb18-391"><a href="#cb18-391" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">"observations"</span></span>
<span id="cb18-392"><a href="#cb18-392" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-393"><a href="#cb18-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-394"><a href="#cb18-394" aria-hidden="true" tabindex="-1"></a><span class="co"># plot of distribution </span></span>
<span id="cb18-395"><a href="#cb18-395" aria-hidden="true" tabindex="-1"></a>x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb18-396"><a href="#cb18-396" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "actual") %&gt;% </span></span>
<span id="cb18-397"><a href="#cb18-397" aria-hidden="true" tabindex="-1"></a> <span class="co"># filter(name == "predicted") %&gt;% </span></span>
<span id="cb18-398"><a href="#cb18-398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> observations, <span class="at">fill =</span> name, <span class="at">col =</span> name))<span class="sc">+</span></span>
<span id="cb18-399"><a href="#cb18-399" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_histogram(alpha = 0.3)+</span></span>
<span id="cb18-400"><a href="#cb18-400" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb18-401"><a href="#cb18-401" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>covariates)</span>
<span id="cb18-402"><a href="#cb18-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-403"><a href="#cb18-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-404"><a href="#cb18-404" aria-hidden="true" tabindex="-1"></a>Table of means for each covariate. </span>
<span id="cb18-405"><a href="#cb18-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-408"><a href="#cb18-408" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-409"><a href="#cb18-409" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb18-410"><a href="#cb18-410" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb18-411"><a href="#cb18-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-412"><a href="#cb18-412" aria-hidden="true" tabindex="-1"></a>  x_comp <span class="sc">%&gt;%</span> </span>
<span id="cb18-413"><a href="#cb18-413" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, covariates) <span class="sc">%&gt;%</span> </span>
<span id="cb18-414"><a href="#cb18-414" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarize</span>(<span class="at">mean =</span> <span class="fu">mean</span>(observations)) <span class="sc">%&gt;%</span> knitr<span class="sc">::</span><span class="fu">kable</span>()</span>
<span id="cb18-415"><a href="#cb18-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-416"><a href="#cb18-416" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-417"><a href="#cb18-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-418"><a href="#cb18-418" aria-hidden="true" tabindex="-1"></a>:::</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<script src="Bayesian_pca_textbook_files/libs/quarto-html/zenscroll-min.js"></script>
</body></html>